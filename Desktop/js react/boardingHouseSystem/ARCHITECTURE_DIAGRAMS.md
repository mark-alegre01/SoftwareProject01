# GCash Integration - Architecture & Flow Diagrams

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (React)                            â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MakePaymentPage.jsx                                         â”‚  â”‚
â”‚  â”‚  â€¢ Payment form                                              â”‚  â”‚
â”‚  â”‚  â€¢ GCash payment button                                      â”‚  â”‚
â”‚  â”‚  â€¢ Status display                                            â”‚  â”‚
â”‚  â”‚  â€¢ Alternative payment methods                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTP Requests
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BACKEND (Express.js)                        â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Routes                                                  â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚  POST /api/gcash/initiate-gcash                             â”‚  â”‚
â”‚  â”‚  GET /api/gcash/gcash-status/:reference                    â”‚  â”‚
â”‚  â”‚  POST /api/webhooks/gcash    (webhook handler)             â”‚  â”‚
â”‚  â”‚  POST /api/payments/:id/refund                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          â–¼                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  GCashService                                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ initiatePayment()                              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ getPaymentStatus()                             â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ verifyWebhookSignature()                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ createRefund()                                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ generateReferenceNumber()                      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTPS API Calls
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GCASH API (Cloud)                             â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Process Payments                                          â”‚  â”‚
â”‚  â”‚  â€¢ Store Transactions                                        â”‚  â”‚
â”‚  â”‚  â€¢ Send Webhooks                                             â”‚  â”‚
â”‚  â”‚  â€¢ Track Status                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Webhook POST
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND (Webhook Handler)                      â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /api/webhooks/gcash                                         â”‚  â”‚
â”‚  â”‚  â€¢ Receive webhook event                                     â”‚  â”‚
â”‚  â”‚  â€¢ Verify signature (HMAC-SHA256)                            â”‚  â”‚
â”‚  â”‚  â€¢ Update payment status                                     â”‚  â”‚
â”‚  â”‚  â€¢ Send confirmation email                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATABASE (JSON)                            â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  db.json                                                     â”‚  â”‚
â”‚  â”‚  â€¢ users[]                                                   â”‚  â”‚
â”‚  â”‚  â€¢ tenants[]                                                 â”‚  â”‚
â”‚  â”‚  â€¢ payments[] (with GCash fields)                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Payment Processing Flow - Detailed Sequence

```
BOARDER                    FRONTEND                    BACKEND                    GCASH
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚  1. Click                 â”‚                          â”‚                          â”‚
   â”‚  Pay with GCash           â”‚                          â”‚                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚                          â”‚  2. POST /gcash/         â”‚                          â”‚
   â”‚                          â”‚  initiate-gcash          â”‚                          â”‚
   â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚  3. Generate Reference   â”‚
   â”‚                          â”‚                          â”‚  Number                  â”‚
   â”‚                          â”‚                          â”‚  (ORD-20250112-ABC123)   â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚  4. Call GCash API       â”‚
   â”‚                          â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                          â”‚                          â”‚  5. Return Payment Link  â”‚
   â”‚                          â”‚                          â”‚  & QR Code               â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
   â”‚                          â”‚  6. Payment Link         â”‚                          â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚  7. Redirect to          â”‚                          â”‚                          â”‚
   â”‚  GCash Payment Link       â”‚                          â”‚                          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚  8. Open GCash App       â”‚                          â”‚                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚  9. Confirm Payment      â”‚                          â”‚                          â”‚
   â”‚  10. Enter PIN           â”‚                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚  11. Payment OK          â”‚                          â”‚                          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚  12. Return to App       â”‚                          â”‚                          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚  13. WEBHOOK             â”‚
   â”‚                          â”‚                          â”‚  payment.completed       â”‚
   â”‚                          â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚  14. Verify Signature    â”‚
   â”‚                          â”‚                          â”‚  15. Update DB           â”‚
   â”‚                          â”‚                          â”‚  16. Send Email          â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚  17. Show Success        â”‚                          â”‚                          â”‚
   â”‚  Message                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚  18. Verify Payment      â”‚                          â”‚                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                          â”‚
   â”‚                          â”‚  GET /gcash/            â”‚                          â”‚
   â”‚                          â”‚  gcash-status/          â”‚                          â”‚
   â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
   â”‚                          â”‚                          â”‚                          â”‚
   â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
   â”‚                          â”‚  Status: PAID            â”‚                          â”‚
   â”‚  19. Success Page        â”‚                          â”‚                          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚                          â”‚
   â”‚                          â”‚                          â”‚                          â”‚
```

---

## Payment Status State Machine

```
                          PAYMENT STATES
                          
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ PENDING  â”‚ â† Initial state
                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚              â”‚                  â”‚
                 â–¼              â–¼                  â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  PAID    â”‚   â”‚ FAILED   â”‚   â”‚ CANCELLED   â”‚
           â”‚ (GCASH)  â”‚   â”‚ (ERROR)  â”‚   â”‚ (USER)      â”‚
           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ (If refunded)
                â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ REFUNDED â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WEBHOOK EVENTS TRIGGER STATE CHANGES:
â€¢ payment.completed    â†’ PAID
â€¢ payment.failed       â†’ FAILED
â€¢ payment.cancelled    â†’ CANCELLED
```

---

## Webhook Verification Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GCash Webhook Arrives                                  â”‚
â”‚  POST /api/webhooks/gcash                               â”‚
â”‚  Headers:                                               â”‚
â”‚    X-Signature: abc123def456...                         â”‚
â”‚  Body:                                                  â”‚
â”‚    {                                                    â”‚
â”‚      "event": "payment.completed",                      â”‚
â”‚      "data": { ... }                                    â”‚
â”‚    }                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Extract Signature from Header                       â”‚
â”‚     signature = "abc123def456..."                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Calculate Expected Signature                        â”‚
â”‚                                                         â”‚
â”‚  calculate_hmac_sha256(                                 â”‚
â”‚    key=GCASH_SECRET_KEY,                                â”‚
â”‚    message=JSON.stringify(request_body)                 â”‚
â”‚  ) = "abc123def456..."                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Compare Signatures                                  â”‚
â”‚                                                         â”‚
â”‚  IF signature == expected:                              â”‚
â”‚    âœ… VALID - Process webhook                           â”‚
â”‚  ELSE:                                                  â”‚
â”‚    âŒ INVALID - Reject webhook (401)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Reference Number Generation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Reference Number Format                       â”‚
â”‚                                                â”‚
â”‚  ORD-YYYYMMDD-XXXXXXXX                         â”‚
â”‚   â†“    â†“       â†“                                â”‚
â”‚   â”‚    â”‚       â””â”€ Random 8-char alphanumeric   â”‚
â”‚   â”‚    â””â”€ Current date (20250112)              â”‚
â”‚   â””â”€ Prefix (Order)                            â”‚
â”‚                                                â”‚
â”‚  Example: ORD-20250112-ABC12345                â”‚
â”‚                                                â”‚
â”‚  Benefits:                                     â”‚
â”‚  â€¢ Human readable with date                    â”‚
â”‚  â€¢ Unique per transaction                      â”‚
â”‚  â€¢ Easy to track by date                       â”‚
â”‚  â€¢ ~4 billion combinations per day             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow - Payment Creation to Confirmation

```
START
  â”‚
  â”œâ”€ Boarder initiates payment
  â”‚  â””â”€ Click "Pay with GCash" button
  â”‚
  â”œâ”€ Frontend calls POST /api/gcash/initiate-gcash
  â”‚  â””â”€ { paymentId, amount, tenantId }
  â”‚
  â”œâ”€ Backend generates reference number
  â”‚  â””â”€ ORD-20250112-ABC123
  â”‚
  â”œâ”€ Backend calls GCash API
  â”‚  â””â”€ Create payment request
  â”‚
  â”œâ”€ GCash returns payment link
  â”‚  â””â”€ https://gcash.com/pay/abc123...
  â”‚
  â”œâ”€ Frontend redirects to payment link
  â”‚  â””â”€ Boarder in GCash app
  â”‚
  â”œâ”€ Boarder confirms payment in GCash
  â”‚  â””â”€ Transaction processed
  â”‚
  â”œâ”€ GCash sends webhook: payment.completed
  â”‚  â””â”€ POST /api/webhooks/gcash
  â”‚
  â”œâ”€ Backend verifies webhook signature
  â”‚  â””â”€ HMAC-SHA256 verification
  â”‚
  â”œâ”€ Backend updates database
  â”‚  â””â”€ status: "paid"
  â”‚  â””â”€ transactionId: "GCASH-123..."
  â”‚  â””â”€ paidDate: today
  â”‚
  â”œâ”€ Send confirmation email
  â”‚  â””â”€ To boarder
  â”‚
  â”œâ”€ Frontend shows success page
  â”‚  â””â”€ Payment confirmed
  â”‚
  â”œâ”€ Landlord dashboard updates
  â”‚  â””â”€ Sees payment marked as paid
  â”‚
  â””â”€ END
```

---

## Error Handling Flow

```
                    PAYMENT INITIATED
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Call GCash   â”‚
                    â”‚ API          â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚   â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                         â”‚
              â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ SUCCESS    â”‚          â”‚ ERROR        â”‚
        â”‚ Return     â”‚          â”‚ â€¢ Invalid    â”‚
        â”‚ Payment    â”‚          â”‚   key        â”‚
        â”‚ Link       â”‚          â”‚ â€¢ Network    â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚ â€¢ API Down   â”‚
              â”‚                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”               â”‚
        â”‚            â”‚               â”‚
        â–¼            â–¼               â–¼
     REDIRECT   WEBHOOK     RETURN ERROR
     TO GCASH   ARRIVES     TO FRONTEND
        â”‚            â”‚              â”‚
        â”‚            â–¼              â”‚
        â”‚      WEBHOOK HANDLER      â”‚
        â”‚      â€¢ Verify Sig â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚      â€¢ Update DB    â””â”€ Invalid Sig?
        â”‚      â€¢ Send Email       Return 401
        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  PAYMENT COMPLETE
```

---

## File Dependencies

```
MakePaymentPage.jsx
    â”‚
    â”œâ”€ hooks React components
    â”œâ”€ calls POST /api/gcash/initiate-gcash
    â””â”€ redirects to GCash
         â”‚
         â–¼
    gcashPayments.js (routes)
    â”‚
    â”œâ”€ endpoint: POST /api/gcash/initiate-gcash
    â”œâ”€ imports GCashService
    â”œâ”€ calls GCashService.initiatePayment()
    â”œâ”€ updates database
    â””â”€ returns payment link
         â”‚
         â–¼
    gcashService.js
    â”‚
    â”œâ”€ initiatePayment()
    â”œâ”€ uses axios to call GCash API
    â”œâ”€ generates reference number
    â”œâ”€ verifies signatures
    â””â”€ handles API responses
         â”‚
         â–¼
    GCash API (Cloud)
         â”‚
         â”œâ”€ Processes payment
         â”œâ”€ Sends webhook event
         â””â”€ sends POST to /api/webhooks/gcash
              â”‚
              â–¼
         webhooks.js (routes)
         â”‚
         â”œâ”€ endpoint: POST /api/webhooks/gcash
         â”œâ”€ imports GCashService
         â”œâ”€ calls verifyWebhookSignature()
         â”œâ”€ updates database
         â”œâ”€ sends email
         â””â”€ returns 200 OK
              â”‚
              â–¼
         database.js
         â”‚
         â””â”€ stores updated payment record
```

---

## Security Validation Chain

```
REQUEST FROM GCASH
    â”‚
    â–¼
EXTRACT X-SIGNATURE HEADER
    â”‚
    â–¼
VERIFY HMAC-SHA256
    â”‚
    â”œâ”€ NO  â”€> RETURN 401 UNAUTHORIZED âŒ
    â”‚
    â”œâ”€ YES â”€> CONTINUE
    â”‚
    â–¼
VALIDATE PAYLOAD FORMAT
    â”‚
    â”œâ”€ INVALID â”€> RETURN 400 BAD REQUEST âŒ
    â”‚
    â”œâ”€ VALID â”€> CONTINUE
    â”‚
    â–¼
CHECK IF PAYMENT EXISTS
    â”‚
    â”œâ”€ NOT FOUND â”€> LOG WARNING âš ï¸
    â”‚
    â”œâ”€ EXISTS â”€> CONTINUE
    â”‚
    â–¼
CHECK FOR DUPLICATES
    â”‚
    â”œâ”€ ALREADY PROCESSED â”€> SKIP UPDATE âœ…
    â”‚
    â”œâ”€ NEW â”€> PROCESS UPDATE
    â”‚
    â–¼
UPDATE DATABASE
    â”‚
    â–¼
SEND CONFIRMATION
    â”‚
    â–¼
RETURN 200 OK âœ…
```

---

## Webhook Retry Logic

```
GCash sends webhook
    â”‚
    â”œâ”€ Success (200) â”€â”€â”€â”€> DONE âœ…
    â”‚
    â””â”€ No response / Error
        â”‚
        â”œâ”€ First Retry (30 seconds later)
        â”‚   â”œâ”€ Success â”€â”€> DONE âœ…
        â”‚   â””â”€ Fail â”€â”€â”€â”€â”€> Continue
        â”‚
        â”œâ”€ Second Retry (5 minutes later)
        â”‚   â”œâ”€ Success â”€â”€> DONE âœ…
        â”‚   â””â”€ Fail â”€â”€â”€â”€â”€> Continue
        â”‚
        â”œâ”€ Third Retry (30 minutes later)
        â”‚   â”œâ”€ Success â”€â”€> DONE âœ…
        â”‚   â””â”€ Fail â”€â”€â”€â”€â”€> Continue
        â”‚
        â””â”€ Fourth Retry (24 hours later)
            â”œâ”€ Success â”€â”€> DONE âœ…
            â””â”€ Fail â”€â”€â”€â”€â”€> LOG WARNING âš ï¸
```

---

This comprehensive diagram set helps visualize how all the components work together! ğŸ¯
