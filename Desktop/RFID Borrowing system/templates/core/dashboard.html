{% extends 'core/base.html' %}

{% block title %}Dashboard - RFID Borrowing System{% endblock %}

{% block extra_css %}
<style>
  #openTable, #logBookTable {
    width: 100%;
    min-width: 100%;
  }

  #openTable thead th:nth-child(1),
  #openTable tbody td:nth-child(1) {
    width: 20%;
    min-width: 200px;
  }

  #openTable thead th:nth-child(2),
  #openTable tbody td:nth-child(2) {
    width: 25%;
    min-width: 250px;
  }

  #openTable thead th:nth-child(3),
  #openTable tbody td:nth-child(3) {
    width: 12%;
    min-width: 100px;
    text-align: center;
  }

  #openTable thead th:nth-child(4),
  #openTable tbody td:nth-child(4) {
    width: 23%;
    min-width: 200px;
  }

  #openTable thead th:nth-child(5),
  #openTable tbody td:nth-child(5) {
    width: 20%;
    min-width: 170px;
    text-align: center;
  }

  #logBookTable thead th:nth-child(1),
  #logBookTable tbody td:nth-child(1) {
    width: 18%;
    min-width: 160px;
  }

  #logBookTable thead th:nth-child(2),
  #logBookTable tbody td:nth-child(2) {
    width: 20%;
    min-width: 180px;
  }

  #logBookTable thead th:nth-child(3),
  #logBookTable tbody td:nth-child(3) {
    width: 15%;
    min-width: 140px;
  }

  #logBookTable thead th:nth-child(4),
  #logBookTable tbody td:nth-child(4) {
    width: 18%;
    min-width: 160px;
  }

  #logBookTable thead th:nth-child(5),
  #logBookTable tbody td:nth-child(5) {
    width: 12%;
    min-width: 100px;
    text-align: center;
  }

  #logBookTable thead th:nth-child(6),
  #logBookTable tbody td:nth-child(6) {
    width: 17%;
    min-width: 160px;
  }

  .content-card {
    margin-bottom: 24px;
  }

  .content-card > div[style*="overflow-x: auto"] {
    border-radius: 18px;
    background: rgba(15, 23, 42, 0.4);
    padding: 2px;
  }

  table tbody td {
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 0;
  }

  /* Allow badges and buttons to wrap properly */
  table tbody td .badge,
  table tbody td button,
  table tbody td .action-btn {
    white-space: normal;
    display: inline-block;
  }

  /* Ensure long text wraps properly */
  table tbody td.mono {
    word-break: break-all;
    white-space: normal;
  }

  /* Status column should center align */
  #openTable tbody td:nth-child(3),
  #logBookTable tbody td:nth-child(5) {
    text-align: center;
  }

  /* Actions column should center align */
  #openTable tbody td:nth-child(5) {
    text-align: center;
  }

  /* Improve empty state visibility */
  table tbody td[colspan] {
    text-align: center;
    padding: 32px 24px;
    color: #94a3b8;
    font-style: italic;
    white-space: normal;
  }

  /* Ensure table containers are visible */
  .content-card > div[style*="overflow-x: auto"] {
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(59, 130, 246, 0.5) rgba(15, 23, 42, 0.3);
  }

  .content-card > div[style*="overflow-x: auto"]::-webkit-scrollbar {
    height: 8px;
  }

  .content-card > div[style*="overflow-x: auto"]::-webkit-scrollbar-track {
    background: rgba(15, 23, 42, 0.3);
    border-radius: 4px;
  }

  .content-card > div[style*="overflow-x: auto"]::-webkit-scrollbar-thumb {
    background: rgba(59, 130, 246, 0.5);
    border-radius: 4px;
  }

  .content-card > div[style*="overflow-x: auto"]::-webkit-scrollbar-thumb:hover {
    background: rgba(59, 130, 246, 0.7);
  }

  /* Ensure tables are full width and visible */
  #openTable, #logBookTable {
    display: table;
    table-layout: fixed;
  }
</style>
{% endblock %}

{% block content %}
<!-- Key Metrics Section -->
<section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
  <!-- Metric Card 1: Total Borrowers -->
  <div class="card-base p-6 bg-gradient-to-br from-gray-50 to-white hover:shadow-md hover:scale-[1.01]">
    <p class="text-sm font-medium text-gray-600">Total Borrowers</p>
    <p class="text-4xl font-extrabold text-gray-900 mt-2">{{ borrower_count }}</p>
    <p class="text-sm text-gray-600 mt-1 flex items-center">
      <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.143M9 16l-1 1m0-2v-2"></path></svg>
      Registered users
    </p>
  </div>

  <!-- Metric Card 2: Total Items -->
  <div class="card-base p-6 bg-gradient-to-br from-gray-50 to-white hover:shadow-md hover:scale-[1.01]">
    <p class="text-sm font-medium text-gray-600">Total Inventory Items</p>
    <p class="text-4xl font-extrabold text-gray-900 mt-2">{{ item_count }}</p>
    <p class="text-sm text-gray-600 mt-1 flex items-center">
      <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
      Available for checkout
    </p>
  </div>

  <!-- Metric Card 3: Open Transactions -->
  <div class="card-base p-6 bg-gradient-to-br from-gray-50 to-white hover:shadow-md hover:scale-[1.01]">
    <p class="text-sm font-medium text-gray-600">Items Currently Checked Out</p>
    <p class="text-4xl font-extrabold text-gray-900 mt-2" id="openCount">{{ open_transactions|length }}</p>
    <p class="text-sm text-gray-600 mt-1 flex items-center">
      <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2zM4 14v6a2 2 0 002 2h12a2 2 0 002-2v-6M5 12h14a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v6a1 1 0 001 1z"></path></svg>
      Active borrowings
    </p>
  </div>

  <!-- Metric Card 4: Quick Actions -->
  <div class="card-base p-6 bg-gradient-to-br from-gray-50 to-white hover:shadow-md hover:scale-[1.01]">
    <p class="text-sm font-medium text-gray-600">Quick Actions</p>
    <button id="refreshOpen" class="w-full mt-4 bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition duration-150 shadow-lg">
      üîÑ Refresh Data
    </button>
  </div>
</section>

<div class="content-card gradient-warm-orange">

  <h2 class="text-xl font-bold text-gray-800 mb-4">Open Transactions</h2>
  <input id="filterOpen" type="search" placeholder="üîç Filter by item or borrower..." class="py-2 pl-10 pr-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 text-sm w-full mb-4 bg-gray-50" />
  <div style="overflow-x: auto;">
    <table id="openTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>Borrower</th>
          <th>Status</th>
          <th>Borrowed At</th>
          {% if request.user.is_staff %}
          <th style="width: 170px;">Actions</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for tx in open_transactions %}
        <tr data-tx-id="{{ tx.id }}" data-borrower-name="{{ tx.borrower.name }}" data-borrower-rfid="{{ tx.borrower.rfid_uid }}" data-item-name="{{ tx.item.name }}" data-item-qr="{{ tx.item.qr_code }}" data-status="{{ tx.status }}">
          <td data-item="{{ tx.item.name }} {{ tx.item.qr_code }}"><span class="mono">{{ tx.item.qr_code }}</span></td>
          <td data-borrower="{{ tx.borrower.name }} {{ tx.borrower.rfid_uid }}">{{ tx.borrower.name }} <span class="mono">({{ tx.borrower.rfid_uid }})</span></td>
          <td><span class="badge badge-warning">{{ tx.status }}</span></td>
          <td>{{ tx.borrowed_at }}</td>
          {% if request.user.is_staff %}
          <td>
            <div style="display:flex; gap:6px; flex-wrap: wrap;">
              <button type="button" class="action-btn action-btn--edit edit-tx-btn" data-tx-id="{{ tx.id }}" title="Edit transaction" aria-label="Edit transaction">‚úèÔ∏è</button>
              <button type="button" class="action-btn action-btn--delete delete-tx-btn" data-tx-id="{{ tx.id }}" title="Delete transaction" aria-label="Delete transaction">üóëÔ∏è</button>
            </div>
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="{% if request.user.is_staff %}5{% else %}4{% endif %}" style="text-align: center; padding: 24px; color: #6b7280;">No open transactions</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if request.user.is_staff %}
  <dialog id="editTransactionDialog">
    <form id="editTransactionForm" method="dialog">
      <h3>Edit Transaction</h3>
      <label>Borrower RFID UID
        <input type="text" id="editTxBorrowerRfid" class="mono" required />
      </label>
      <label>Item QR Code
        <input type="text" id="editTxItemQr" class="mono" required />
      </label>
      <label>Status
        <select id="editTxStatus">
          <option value="OPEN">OPEN</option>
          <option value="RETURNED">RETURNED</option>
        </select>
      </label>
      <div class="modal-actions">
        <button type="submit" class="btn btn-success btn-lg" style="flex:1;">
          <span class="btn-icon">üíæ</span>
          <span class="btn-text">Save</span>
        </button>
        <button type="button" id="cancelEditTxBtn" class="btn btn-secondary btn-lg" style="flex:1;">
          <span class="btn-icon">‚úï</span>
          <span class="btn-text">Cancel</span>
        </button>
      </div>
    </form>
  </dialog>

  <dialog id="deleteTransactionDialog">
    <form method="dialog">
      <h3>üóëÔ∏è Delete Transaction</h3>
      <div class="modal-message" id="deleteTxMessage">
        Are you sure you want to delete this transaction? This action cannot be undone.
      </div>
      <div class="modal-actions">
        <button type="button" id="confirmDeleteTxBtn" class="btn btn-danger btn-lg" style="flex:1;">
          <span class="btn-icon">üóëÔ∏è</span>
          <span class="btn-text">Delete</span>
        </button>
        <button type="button" id="cancelDeleteTxBtn" class="btn btn-secondary btn-lg" style="flex:1;">
          <span class="btn-icon">‚úï</span>
          <span class="btn-text">Cancel</span>
        </button>
      </div>
    </form>
  </dialog>
  {% endif %}
</div>

<div class="content-card gradient-warm-amber">
  <h2 class="text-xl font-bold text-gray-800 mb-4">Borrowing Log Book</h2>
  <div style="overflow-x: auto;">
    <table id="logBookTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>Borrower</th>
          <th>RFID UID</th>
          <th>Item</th>
          <th>Status</th>
          <th>Returned At</th>
        </tr>
      </thead>
      <tbody id="logBookBody">
        {% for tx in all_transactions %}
        <tr>
          <td>{{ tx.borrowed_at|date:"Y-m-d H:i:s" }}</td>
          <td>{{ tx.borrower.name }}</td>
          <td class="mono">{{ tx.borrower.rfid_uid }}</td>
          <td class="mono">{{ tx.item.qr_code }}</td>
          <td>
            {% if tx.status == "OPEN" %}
              <span class="badge badge-warning">{{ tx.status }}</span>
            {% else %}
              <span class="badge badge-success">{{ tx.status }}</span>
            {% endif %}
          </td>
          <td>{{ tx.returned_at|date:"Y-m-d H:i:s"|default:"‚Äî" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6" style="text-align: center; padding: 24px; color: #6b7280;">No transactions yet. Tap an RFID card to create a log entry.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<dialog id="dashboardToast"></dialog>
{% endblock %}

{% block extra_js %}
<script>
  // Note: Django template variables below - linter may show false warnings
  // eslint-disable-next-line no-undef
  const isAdmin = {{ request.user.is_staff|lower }};
  const apiBase = '/api';
  let editingTxId = null;

  function filterOpenTable() {
    const query = document.getElementById('filterOpen').value.trim().toLowerCase();
    const rows = document.querySelectorAll('#openTable tbody tr');
    rows.forEach(row => {
      const item = (row.querySelector('[data-item]')?.getAttribute('data-item') || '').toLowerCase();
      const borrower = (row.querySelector('[data-borrower]')?.getAttribute('data-borrower') || '').toLowerCase();
      const match = !query || item.includes(query) || borrower.includes(query);
      row.style.display = match ? '' : 'none';
    });
  }

  function getCsrfToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? decodeURIComponent(match[1]) : '';
  }

  function showDashboardToast(message) {
    const dialog = document.getElementById('dashboardToast');
    if (!dialog) {
      alert(message);
      return;
    }
    dialog.textContent = message;
    dialog.showModal();
    setTimeout(() => dialog.close(), 2000);
  }

  function bindTxActionButtons() {
    if (!isAdmin) return;
    document.querySelectorAll('.edit-tx-btn').forEach(btn => {
      btn.onclick = () => {
        const row = btn.closest('tr');
        if (!row) return;
        editingTxId = btn.dataset.txId;
        document.getElementById('editTxBorrowerRfid').value = row.dataset.borrowerRfid || '';
        document.getElementById('editTxItemQr').value = row.dataset.itemQr || '';
        document.getElementById('editTxStatus').value = row.dataset.status || 'OPEN';
        document.getElementById('editTransactionDialog')?.showModal();
      };
    });
    document.querySelectorAll('.delete-tx-btn').forEach(btn => {
      btn.onclick = () => {
        const txId = btn.dataset.txId;
        if (!txId) return;
        const row = btn.closest('tr');
        const itemName = row?.dataset.itemQr || 'Unknown';
        const borrowerName = row?.dataset.borrowerName || 'Unknown';
        
        document.getElementById('deleteTxMessage').innerHTML = `
          <strong>Are you sure you want to delete this transaction?</strong><br><br>
          <div style="text-align: left; margin-top: 12px;">
            <div><strong>Item:</strong> <span class="mono">${itemName}</span></div>
            <div><strong>Borrower:</strong> ${borrowerName}</div>
          </div>
          <div style="margin-top: 16px; padding: 12px; background: #fee2e2; border-radius: 8px; color: #991b1b; border-left: 4px solid #dc2626;">
            ‚ö†Ô∏è This action cannot be undone.
          </div>
        `;
        
        const deleteDialog = document.getElementById('deleteTransactionDialog');
        const confirmBtn = document.getElementById('confirmDeleteTxBtn');
        const cancelBtn = document.getElementById('cancelDeleteTxBtn');
        
        // Remove old listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        newConfirmBtn.onclick = async () => {
          deleteDialog.close();
          try {
            const res = await fetch(`${apiBase}/transactions/${txId}`, {
              method: 'DELETE',
              headers: {
                'X-CSRFToken': getCsrfToken()
              }
            });
            if (!res.ok && res.status !== 204) {
              const data = await res.json().catch(() => ({}));
              throw new Error(data.detail || 'Delete failed');
            }
            showDashboardToast('üóëÔ∏è Transaction deleted');
            await refreshOpenButton();
          } catch (err) {
            showDashboardToast(`‚ùå ${err.message || 'Delete failed'}`);
          }
        };
        
        newCancelBtn.onclick = () => {
          deleteDialog.close();
        };
        
        deleteDialog.showModal();
      };
    });
  }

  async function fetchOpenTransactions() {
    try {
      const html = await fetch(window.location.href, { headers: { 'X-Fragment': '1' }}).then(r => r.text());
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newBody = doc.querySelector('#openTable tbody');
      const oldBody = document.querySelector('#openTable tbody');
      if (newBody && oldBody) {
        oldBody.innerHTML = newBody.innerHTML;
        const count = oldBody.querySelectorAll('tr[data-tx-id]').length;
        document.getElementById('openCount').textContent = count;
        if (isAdmin) {
          bindTxActionButtons();
        }
        filterOpenTable();
      }
    } catch (e) {
      // ignore
    }
  }

  async function refreshLogBook() {
    try {
      const html = await fetch(window.location.href).then(r => r.text());
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newBody = doc.querySelector('#logBookTable tbody');
      const oldBody = document.querySelector('#logBookTable tbody');
      if (newBody && oldBody) {
        oldBody.innerHTML = newBody.innerHTML;
      }
    } catch (e) {
      // ignore
    }
  }

  async function refreshOpenButton() {
    await fetchOpenTransactions();
    await refreshLogBook();
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('filterOpen').addEventListener('input', filterOpenTable);
    document.getElementById('refreshOpen').addEventListener('click', refreshOpenButton);
    if (isAdmin) {
      bindTxActionButtons();
      const editForm = document.getElementById('editTransactionForm');
      const editDialog = document.getElementById('editTransactionDialog');
      const cancelBtn = document.getElementById('cancelEditTxBtn');
      cancelBtn?.addEventListener('click', () => {
        editDialog?.close();
        editingTxId = null;
      });
      
      // Close edit dialog when clicking outside
      editDialog?.addEventListener('click', (e) => {
        if (e.target === editDialog) {
          editDialog.close();
          editingTxId = null;
        }
      });
      
      // Close delete dialog when clicking outside
      const deleteDialog = document.getElementById('deleteTransactionDialog');
      deleteDialog?.addEventListener('click', (e) => {
        if (e.target === deleteDialog) {
          deleteDialog.close();
        }
      });
      editForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!editingTxId) {
          showDashboardToast('No transaction selected.');
          return;
        }
        const payload = {
          borrower_rfid: document.getElementById('editTxBorrowerRfid').value.trim(),
          item_qr: document.getElementById('editTxItemQr').value.trim(),
          status: document.getElementById('editTxStatus').value
        };
        try {
          const res = await fetch(`${apiBase}/transactions/${editingTxId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            throw new Error(data.detail || 'Update failed');
          }
          showDashboardToast('üíæ Transaction updated');
          editDialog?.close();
          editingTxId = null;
          await refreshOpenButton();
        } catch (error) {
          showDashboardToast(`‚ùå ${error.message || 'Update failed'}`);
        }
      });
    }
    setInterval(async () => {
      await fetchOpenTransactions();
      await refreshLogBook();
    }, 10000);
  });
</script>
{% endblock %}
