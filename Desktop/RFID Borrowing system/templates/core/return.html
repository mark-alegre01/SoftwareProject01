{% extends 'core/base.html' %}

{% block title %}Return Item - RFID Borrowing System{% endblock %}

{% block content %}
<style>
/* Compact return container */
.return-container {
  max-width: 350px !important;
  margin: 0 auto !important;
  width: 100% !important;
}

#returnQrReader { 
  min-height: 240px !important; 
  height: auto !important; 
  width: 100% !important;
  aspect-ratio: 1 !important;
  border-radius: 12px !important; 
  overflow: hidden !important; 
  position: relative !important; 
  background: #000 !important; 
  display: flex !important; 
  align-items: center !important; 
  justify-content: center !important;
}

/* Ensure Html5Qrcode overlay is visible and styled nicely */
#returnQrReader .qrbox { 
  border: 3px solid rgba(2,132,199,0.95) !important; 
  box-sizing: border-box !important; 
  border-radius: 10px !important; 
  position: relative !important; 
}

#returnQrReader .html5-qrcode-mask { 
  background: rgba(0,0,0,0.5) !important; 
}

#returnQrReader .html5-qrcode-mask .html5-qrcode-mask-inner { 
  background: transparent !important; 
}

#returnQrReader video { 
  width: 100% !important; 
  height: auto !important; 
  display: block !important; 
}

#returnQrReader canvas { 
  width: 100% !important; 
  height: auto !important; 
}

/* Corner brackets for better visual guide */
.return-qr-corner {
  position: absolute;
  width: 28px;
  height: 28px;
  border: 3px solid #06b6d4;
  pointer-events: none;
  z-index: 20;
  animation: cornerPulse 1.5s infinite;
}

.return-qr-corner.top-left {
  top: 0;
  left: 0;
  border-right: none;
  border-bottom: none;
}

.return-qr-corner.top-right {
  top: 0;
  right: 0;
  border-left: none;
  border-bottom: none;
}

.return-qr-corner.bottom-left {
  bottom: 0;
  left: 0;
  border-right: none;
  border-top: none;
}

.return-qr-corner.bottom-right {
  bottom: 0;
  right: 0;
  border-left: none;
  border-top: none;
}

@keyframes cornerPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Compact content card */
.content-card.gradient-warm-red {
  padding: 20px !important;
  max-width: 100% !important;
}

/* Status display */
#returnQrStatus {
  padding: 12px !important;
  text-align: center !important;
  font-size: 13px !important;
  color: #666 !important;
  margin: 12px 0 !important;
  border-radius: 8px !important;
  background: #f5f5f5 !important;
  font-weight: 500 !important;
}

#returnQrStatus.scan-status.error {
  background: #fee2e2 !important;
  color: #dc2626 !important;
}

#returnQrStatus.scan-status.success {
  background: #dcfce7 !important;
  color: #16a34a !important;
}

#returnQrStatus.scan-status.waiting {
  background: #fef3c7 !important;
  color: #92400e !important;
}

/* Button styling */
#stopReturnQrScan {
  margin-top: 12px !important;
  font-size: 14px !important;
}

/* Form styling */
#returnForm {
  margin-top: 16px !important;
}

#returnForm label {
  display: block;
  margin-bottom: 12px;
  font-weight: 600;
  color: #333;
  font-size: 14px;
}

#returnForm input {
  width: 100% !important;
  padding: 12px !important;
  border: 2px solid #e5e7eb !important;
  border-radius: 12px !important;
  font-size: 14px !important;
  transition: border-color 0.2s !important;
  box-sizing: border-box !important;
}

#returnForm input:focus {
  border-color: #ef4444 !important;
  outline: none !important;
}

#returnForm > div {
  display: flex !important;
  gap: 12px !important;
  margin-top: 16px !important;
}

#returnForm button {
  font-size: 14px !important;
  padding: 12px 16px !important;
  flex: 1 !important;
  height: auto !important;
}

/* Responsive adjustments */
@media (max-width: 480px) {
  .return-container {
    max-width: 100% !important;
    padding: 0 12px !important;
  }
  
  #returnQrReader {
    height: 300px !important;
  }
  
  .content-card.gradient-warm-red {
    padding: 16px !important;
  }
}
</style>

<div class="page-header">
  <h1>â†©ï¸ Return Item</h1>
  <p>Scan the item QR code to return it</p>
</div>

<div class="content-card gradient-warm-red return-container">
  <!-- QR Reader Container Wrapper -->
  <div style="position: relative; display: flex; flex-direction: column;">
    <!-- Corner brackets overlay -->
    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 30; border-radius: 14px;">
      <div class="return-qr-corner top-left"></div>
      <div class="return-qr-corner top-right"></div>
      <div class="return-qr-corner bottom-left"></div>
      <div class="return-qr-corner bottom-right"></div>
    </div>
    <!-- QR Reader Container -->
    <div id="returnQrReader" style="width: 100%; border: none; border-radius: 14px; overflow: hidden; background: #000; min-height: 280px; position: relative;">
    </div>
  </div>

  <!-- QR Status Message -->
  <div id="returnQrStatus" style="padding: 12px; border-radius: 12px; font-weight: 700; font-size: 13px; text-align: center; color: #164e63; background: #cffafe; border: 2px solid #06b6d4; min-height: 20px;">ğŸ“· Starting camera...</div>

  <!-- Camera Permission Help (Hidden initially) -->
  <div id="cameraPermissionHelp" class="hidden" style="background: #fef3c7; padding: 12px; border-radius: 12px; border-left: 4px solid #f59e0b;">
    <div style="font-weight: 700; color: #92400e; font-size: 13px; margin-bottom: 8px;">Camera access needed</div>
    <button type="button" id="retryReturnCamera" class="btn btn-primary btn-lg" style="width: 100%; height: 45px; font-size: 14px; font-weight: 700; border-radius: 10px; background: #06b6d4; border: none; color: white; cursor: pointer;">ğŸ”„ Enable Camera</button>
  </div>

  <button type="button" class="btn btn-secondary btn-lg" id="stopReturnQrScan" style="width: 100%; margin-top: 12px;">
    <span class="btn-icon">â¹ï¸</span>
    <span class="btn-text">Stop Camera</span>
  </button>

  <form id="returnForm" class="hidden">
    {% csrf_token %}
    <label>Item QR or Transaction ID
      <input id="returnInput" class="mono" type="text" placeholder="Scan QR or enter transaction ID" required />
    </label>
    <div>
      <button type="submit" class="btn btn-success">
        <span class="btn-icon">âœ“</span>
        <span class="btn-text">Return Item</span>
      </button>
      <button type="button" class="btn btn-secondary" id="clearReturn">
        <span class="btn-icon">ğŸ—‘ï¸</span>
        <span class="btn-text">Clear</span>
      </button>
    </div>
  </form>
  <dialog id="returnToast"></dialog>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const apiBase = '/api';
  let returnQrScanner = null;
  let scannedReturn = null;
  const csrfToken = document.querySelector('#returnForm [name=csrfmiddlewaretoken]')?.value;

  function showToast(dialog, message) {
    dialog.textContent = message;
    dialog.showModal();
    setTimeout(() => dialog.close(), 2200);
  }

  // Ensure Html5Qrcode library is loaded
  if (typeof Html5Qrcode === 'undefined') {
    console.error('Html5Qrcode library not loaded!');
    document.getElementById('returnQrStatus').textContent = 'âŒ QR Code library failed to load. Please refresh the page.';
    document.getElementById('returnQrStatus').style.color = '#dc2626';
  }

  // Detect if page is served over HTTPS
  const isSecureContext = window.isSecureContext || window.location.protocol === 'https:';
  
  console.log('Return page loaded. HTTPS enabled:', isSecureContext);
  console.log('Html5Qrcode available:', typeof Html5Qrcode !== 'undefined');

  // Handle file input (photo capture) - works on HTTP
  const photoInput = document.getElementById('qrPhotoInput');
  if (photoInput) {
    photoInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    document.getElementById('returnQrStatus').textContent = 'â³ Processing photo...';
    document.getElementById('returnQrStatus').className = 'scan-status waiting';
    
    try {
      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const imageData = event.target.result;
          
          // Use Html5Qrcode to decode the QR from the image
          if (!returnQrScanner) {
            returnQrScanner = new Html5Qrcode('returnQrReader');
          }
          
          const result = await returnQrScanner.scanFile(imageData, false);
          if (result) {
            const qrValue = result.trim();
            document.getElementById('returnQrStatus').textContent = `âœ… QR Code found: ${qrValue}`;
            document.getElementById('returnQrStatus').className = 'scan-status success';
            
            const formEl = document.getElementById('returnForm');
            const inputEl = document.getElementById('returnInput');
            inputEl.value = qrValue;
            formEl.classList.remove('hidden');
            inputEl.focus();
          }
        } catch (err) {
          document.getElementById('returnQrStatus').textContent = 'âŒ No QR code found in photo. Try again with a clearer image.';
          document.getElementById('returnQrStatus').className = 'scan-status error';
        }
      };
      reader.readAsDataURL(file);
    } catch (err) {
      document.getElementById('returnQrStatus').textContent = `âŒ Error: ${err.message}`;
      document.getElementById('returnQrStatus').className = 'scan-status error';
    }
    
    // Reset file input
    e.target.value = '';
    });
  }

  async function startReturnQrScanner(usePhoneCameraUrl = null) {
    try {
      const qrReader = document.getElementById('returnQrReader');
      console.log('ğŸ¬ startReturnQrScanner called, isSecureContext:', isSecureContext);
      
      // Clear previous scanner content
      qrReader.innerHTML = '';
      
      // If using phone camera URL, create video element and scan frames
      if (usePhoneCameraUrl) {
        document.getElementById('returnQrStatus').textContent = 'ğŸ“· Connecting to phone camera...';
        document.getElementById('returnQrStatus').className = 'scan-status waiting';
        
        // Create video element to play the stream
        const video = document.createElement('video');
        video.src = usePhoneCameraUrl;
        video.autoplay = true;
        video.playsInline = true;
        video.style.width = '100%';
        video.style.borderRadius = '12px';
        video.style.display = 'block';
        
        qrReader.innerHTML = '';
        qrReader.appendChild(video);
        
        // Create canvas to capture frames
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        returnQrScanner = new Html5Qrcode('returnQrReader');
        let scanInterval = null;
        
        video.onloadedmetadata = () => {
          // Set canvas dimensions based on video
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          video.play();
          document.getElementById('returnQrStatus').textContent = 'ğŸ“· Phone camera ready. Point at QR code...';
          document.getElementById('returnQrStatus').className = 'scan-status waiting';
          
          // Start scanning frames
          scanInterval = setInterval(async () => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
              try {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/png');
                
                const result = await returnQrScanner.scanFile(imageData, false);
                if (result) {
                  const qrValue = result.trim();
                  if (scannedReturn === qrValue) return;
                  scannedReturn = qrValue;
                  clearInterval(scanInterval);
                  document.getElementById('returnQrStatus').textContent = `âœ… QR Code scanned: ${qrValue}`;
                  document.getElementById('returnQrStatus').className = 'scan-status success';
                  video.pause();
                  // Populate input and show confirm form
                  const formEl = document.getElementById('returnForm');
                  const inputEl = document.getElementById('returnInput');
                  inputEl.value = qrValue;
                  formEl.classList.remove('hidden');
                  inputEl.focus();
                }
              } catch (e) {
                // No QR code found, continue scanning
              }
            }
          }, 500); // Scan every 500ms
          
          // Store interval to clear it later
          returnQrScanner._scanInterval = scanInterval;
          returnQrScanner._video = video;
        };
        
        video.onerror = () => {
          document.getElementById('returnQrStatus').textContent = 'âŒ Could not connect to phone camera. Check the URL and ensure IP Webcam is running.';
          document.getElementById('returnQrStatus').className = 'scan-status error';
        };
        
        return;
      }
      
      // Live camera access (only for HTTPS)
      if (!isSecureContext) {
        document.getElementById('returnQrStatus').textContent = 'âš ï¸ Live camera requires HTTPS. Please use the secure connection.';
        document.getElementById('returnQrStatus').className = 'scan-status error';
        return;
      }
      
      // Stop any existing scanner first to release camera
      if (returnQrScanner) {
        try {
          await returnQrScanner.stop();
          returnQrScanner.clear();
        } catch (e) {
          // Ignore errors when stopping
          console.warn('Error stopping previous scanner:', e);
        }
        returnQrScanner = null;
      }
      
      // Wait a moment for camera to be released
      await new Promise(resolve => setTimeout(resolve, 300));
      
      console.log('Creating new Html5Qrcode instance for returnQrReader...');
      document.getElementById('returnQrStatus').textContent = 'ğŸ“· Starting camera...';
      document.getElementById('returnQrStatus').className = 'scan-status waiting';
      
      returnQrScanner = new Html5Qrcode('returnQrReader');
      
      let returnQrScannerProcessing = false;
      
      // Try back camera first, fallback to any camera
      let cameraId = null;
      let config = { facingMode: { ideal: 'environment' } };
      
      try {
        const devices = await Html5Qrcode.getCameras();
        console.log('Available cameras:', devices);
        if (devices && devices.length > 0) {
          const backCamera = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('rear'));
          cameraId = backCamera ? backCamera.id : devices[0].id;
          config = { deviceId: { exact: cameraId } };
          console.log('Using camera:', cameraId);
        }
      } catch (e) {
        console.log('Could not enumerate cameras, using default:', e);
        config = { facingMode: 'environment' };
      }
      
      // Try starting with specific camera
      try {
        // Calculate qrbox size - larger for better detection (matching borrow page)
        const readerWidth = qrReader.clientWidth || Math.floor(qrReader.getBoundingClientRect().width) || Math.floor(window.innerWidth * 0.8);
        const qrboxSize = Math.min(320, readerWidth - 10);
        
        const scanConfig = {
          fps: 30,
          qrbox: { width: qrboxSize, height: qrboxSize },
          disableFlip: false,
          rememberLastUsedCamera: true,
          aspectRatio: 1.0
        };
        
        returnQrScannerProcessing = false;
        
        await returnQrScanner.start(
          config,
          scanConfig,
          async (decodedText, decodedResult) => {
            if (returnQrScannerProcessing) return;
            if (!decodedText || decodedText.trim().length === 0) return;
            
            if (scannedReturn === decodedText.trim()) return;
            
            returnQrScannerProcessing = true;
            scannedReturn = decodedText.trim();
            const qrValue = scannedReturn;
            console.log('âœ… QR Code scanned:', qrValue);
            document.getElementById('returnQrStatus').textContent = `âœ… QR Code scanned: ${qrValue}`;
            document.getElementById('returnQrStatus').className = 'scan-status success';
            
            if (returnQrScanner) {
              try {
                returnQrScanner.stop().then(() => {
                  if (returnQrScanner && returnQrScanner.clear) returnQrScanner.clear();
                  returnQrScanner = null;
                }).catch(() => {
                  returnQrScanner = null;
                });
              } catch(e) { console.error('Error stopping scanner:', e); returnQrScanner = null; }
            }
            
            // Populate input and show confirm form
            const formEl = document.getElementById('returnForm');
            const inputEl = document.getElementById('returnInput');
            inputEl.value = qrValue;
            formEl.classList.remove('hidden');
            inputEl.focus();
          },
          (errorMessage) => {
            // Ignore scanning errors (normal while scanning)
          }
        );
        
        console.log('Html5Qrcode.start succeeded!');
        document.getElementById('returnQrStatus').textContent = 'ğŸ“· Camera ready. Point at QR code...';
        document.getElementById('returnQrStatus').className = 'scan-status waiting';
      } catch (startErr) {
        console.error('Html5Qrcode.start failed:', startErr);
        // If environment camera fails, try without facingMode (fallback for laptops)
        console.log('Camera with facingMode failed, trying fallback config...');
        if (startErr.name === 'NotReadableError' || startErr.name === 'ConstraintNotSatisfiedError') {
          try {
            // Calculate qrbox size - larger for better detection
            const readerWidth = qrReader.clientWidth || Math.floor(qrReader.getBoundingClientRect().width) || Math.floor(window.innerWidth * 0.8);
            const qrboxSize = Math.min(320, readerWidth - 10);
            
            const scanConfig = {
              fps: 30,
              qrbox: { width: qrboxSize, height: qrboxSize },
              disableFlip: false,
              rememberLastUsedCamera: true,
              aspectRatio: 1.0
            };
            
            returnQrScannerProcessing = false;
            
            await returnQrScanner.start(
              {},
              scanConfig,
              async (decodedText, decodedResult) => {
                if (returnQrScannerProcessing) return;
                if (!decodedText || decodedText.trim().length === 0) return;
                
                if (scannedReturn === decodedText.trim()) return;
                
                returnQrScannerProcessing = true;
                scannedReturn = decodedText.trim();
                const qrValue = scannedReturn;
                console.log('âœ… QR Code scanned:', qrValue);
                document.getElementById('returnQrStatus').textContent = `âœ… QR Code scanned: ${qrValue}`;
                document.getElementById('returnQrStatus').className = 'scan-status success';
                
                if (returnQrScanner) {
                  try {
                    returnQrScanner.stop().then(() => {
                      if (returnQrScanner && returnQrScanner.clear) returnQrScanner.clear();
                      returnQrScanner = null;
                    }).catch(() => {
                      returnQrScanner = null;
                    });
                  } catch(e) { console.error('Error stopping scanner:', e); returnQrScanner = null; }
                }
                
                // Populate input and show confirm form
                const formEl = document.getElementById('returnForm');
                const inputEl = document.getElementById('returnInput');
                inputEl.value = qrValue;
                formEl.classList.remove('hidden');
                inputEl.focus();
              },
              (errorMessage) => {
                // Ignore scanning errors
              }
            );
            console.log('âœ… Scanner started successfully with fallback config');
            document.getElementById('returnQrStatus').textContent = 'ğŸ“· Camera active. Point at QR code...';
            document.getElementById('returnQrStatus').className = 'scan-status waiting';
          } catch (fallbackErr) {
            console.error('Fallback camera config also failed:', fallbackErr);
            document.getElementById('returnQrStatus').textContent = 'âŒ Camera error: ' + (fallbackErr.message || 'Could not start camera');
            document.getElementById('returnQrStatus').className = 'scan-status error';
          }
        } else {
          console.error('Unexpected error type:', startErr.name);
          document.getElementById('returnQrStatus').textContent = 'âŒ Error: ' + (startErr.message || 'Camera initialization failed');
          document.getElementById('returnQrStatus').className = 'scan-status error';
        }
      }
    } catch (err) {
      let errorMsg = 'Camera error: ';
      if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
        errorMsg = 'âŒ Camera permission denied. Please allow camera access and try again.';
        document.getElementById('cameraPermissionHelp').classList.remove('hidden');
      } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
        errorMsg = 'âŒ No camera found. Please connect a camera device.';
      } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
        errorMsg = 'âŒ Camera is already in use. Please close other apps using the camera and try again.';
        document.getElementById('cameraPermissionHelp').classList.remove('hidden');
      } else if (err.message) {
        errorMsg = 'âŒ Camera error: ' + err.message;
      } else if (err.toString) {
        errorMsg = 'âŒ Camera error: ' + err.toString();
      } else {
        errorMsg = 'âŒ Unable to access camera. Please check your browser settings and try again.';
      }
      document.getElementById('returnQrStatus').textContent = errorMsg;
      document.getElementById('returnQrStatus').className = 'scan-status error';
      
      // Clean up on error
      if (returnQrScanner) {
        try {
          returnQrScanner.clear();
        } catch (e) {}
        returnQrScanner = null;
      }
    }
  }
  
  // Phone camera handler - only if element exists
  const usePhoneCameraBtn = document.getElementById('usePhoneCamera');
  if (usePhoneCameraBtn) {
    usePhoneCameraBtn.addEventListener('click', () => {
      const phoneUrl = document.getElementById('phoneCameraUrl').value.trim();
      if (!phoneUrl) {
        alert('Please enter a phone camera stream URL (e.g., http://192.168.1.XXX:8080/video)');
        return;
      }
      startReturnQrScanner(phoneUrl);
    });
  }

  function stopReturnQrScanner() {
    if (returnQrScanner) {
      // Clear interval if using phone camera
      if (returnQrScanner._scanInterval) {
        clearInterval(returnQrScanner._scanInterval);
      }
      if (returnQrScanner._video) {
        returnQrScanner._video.pause();
        returnQrScanner._video.src = '';
      }
      returnQrScanner.stop().then(() => {
        returnQrScanner.clear();
        returnQrScanner = null;
        document.getElementById('returnQrReader').innerHTML = '';
        document.getElementById('returnQrStatus').textContent = 'Camera stopped';
        document.getElementById('returnQrStatus').className = 'scan-status';
      }).catch(() => {});
    }
  }

  async function returnAction(evt) {
    evt.preventDefault();
    const toast = document.getElementById('returnToast');
    const value = document.getElementById('returnInput').value.trim();
    if (!value) return;
    const payload = /^\d+$/.test(value) ? { transaction_id: Number(value) } : { item_qr: value };
    try {
      const tokenToSend = csrfToken || (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '';
      if (!tokenToSend) console.warn('No CSRF token found for return');
      const res = await fetch(`${apiBase}/return`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': tokenToSend
        },
        body: JSON.stringify(payload)
      });
      if (res.status === 403) console.error('Return 403; csrftoken cookie=', (document.cookie.match(/csrftoken=([^;]+)/)||[])[1], 'sent header=', tokenToSend);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || 'Return failed');
      showToast(toast, 'âœ… Returned successfully! Redirecting...');
      setTimeout(() => {
        window.location.href = "{% url 'core:dashboard' %}";
      }, 1500);
    } catch (e) {
      showToast(toast, 'âŒ ' + (e.message || 'Error'));
    }
  }

  // Safe event listeners with null checks
  const returnForm = document.getElementById('returnForm');
  if (returnForm) {
    returnForm.addEventListener('submit', returnAction);
  }

  const stopBtn = document.getElementById('stopReturnQrScan');
  if (stopBtn) {
    stopBtn.addEventListener('click', () => {
      stopReturnQrScanner();
    });
  }
      
      // Safe event listeners with null checks
      const retryBtn = document.getElementById('retryReturnCamera');
      if (retryBtn) {
        retryBtn.addEventListener('click', () => {
          console.log('Retry camera button clicked');
          startReturnQrScanner();
        });
      }

      const clearBtn = document.getElementById('clearReturn');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          document.getElementById('returnInput').value = '';
        });
      }

      // Auto-start scanner on page load with better error handling
      window.addEventListener('load', () => {
        console.log('Page fully loaded, starting return QR scanner...');
        setTimeout(() => {
          try {
            startReturnQrScanner();
          } catch (err) {
            console.error('Failed to start camera:', err);
            document.getElementById('returnQrStatus').textContent = 'âŒ Failed to initialize camera: ' + (err.message || err);
            document.getElementById('returnQrStatus').style.color = '#dc2626';
          }
        }, 500);
      });
</script>
{% endblock %}
