{% extends 'core/base.html' %}

{% block title %}Borrow Item - RFID Borrowing System{% endblock %}

{% block content %}
<style>
/* UI polish for the Borrow page */
.page-header { background: linear-gradient(90deg,#06b6d4, #3b82f6); color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(59,130,246,0.18); margin-bottom: 20px;}
.page-header h1 { margin:0; font-size: 28px; font-weight: 800; display:flex; align-items: center; gap: 10px;}
.page-header p { margin: 6px 0 0; opacity: 0.95;}
.btn { transition: transform .15s ease, box-shadow .15s ease; }
.btn:hover{ transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
.content-card { padding: 24px; border-radius: 16px; box-shadow: 0 8px 30px rgba(2,6,23,0.06); background: linear-gradient(180deg, #fff, #f8fafc); }
/* Responsive QR Modal */
#qrScanModal {
  border: none !important;
  border-radius: 20px !important;
  padding: 0 !important;
  width: 90% !important;
  max-width: 500px !important;
  max-height: 85vh !important;
  overflow: hidden !important;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3) !important;
}
#qrScanModal::backdrop {
  background: rgba(0, 0, 0, 0.6);
}
/* Responsive mobile QR scanner */
@media (max-width: 600px) {
  #qrScanModal {
    width: 95% !important;
    max-width: 100% !important;
    max-height: 90vh !important;
    border-radius: 16px !important;
  }
}
#qr-reader { 
  min-height: 240px !important; 
  height: auto !important; 
  width: 100% !important;
  aspect-ratio: 1 !important;
  border-radius: 12px !important; 
  overflow: hidden !important; 
  position: relative !important; 
  background: #000 !important; 
  display: flex !important; 
  align-items: center !important; 
  justify-content: center !important;
}
/* Ensure Html5Qrcode overlay is visible and styled nicely */
#qr-reader .qrbox { 
  border: 3px solid rgba(2,132,199,0.95) !important; 
  box-sizing: border-box !important; 
  border-radius: 10px !important; 
  position: relative !important; 
}
#qr-reader .html5-qrcode-mask { background: rgba(0,0,0,0.5) !important; }
#qr-reader .html5-qrcode-mask .html5-qrcode-mask-inner { background: transparent !important; }
#qr-reader video { width: 100% !important; height: auto !important; display: block !important; }
#qr-reader canvas { width: 100% !important; height: auto !important; }
/* Corner brackets for better visual guide */
.qr-corner {
  position: absolute;
  width: 28px;
  height: 28px;
  border: 3px solid #06b6d4;
  pointer-events: none;
  z-index: 20;
  animation: cornerPulse 1.5s infinite;
}
.qr-corner.top-left { 
  top: 12px;
  left: 12px;
  border-right: none; 
  border-bottom: none; 
  border-radius: 6px 0 0 0; 
}
.qr-corner.top-right { 
  top: 12px;
  right: 12px;
  border-left: none; 
  border-bottom: none; 
  border-radius: 0 6px 0 0; 
}
.qr-corner.bottom-left { 
  bottom: 12px;
  left: 12px;
  border-right: none; 
  border-top: none; 
  border-radius: 0 0 0 6px; 
}
.qr-corner.bottom-right { 
  bottom: 12px;
  right: 12px;
  border-left: none; 
  border-top: none; 
  border-radius: 0 0 6px 0; 
}
@keyframes scanPulseCompact {
  0%, 100% { box-shadow: inset 0 0 0 1000px rgba(0, 0, 0, 0.4), 0 0 0 2px rgba(6, 182, 212, 0.6); }
  50% { box-shadow: inset 0 0 0 1000px rgba(0, 0, 0, 0.4), 0 0 15px 2px rgba(6, 182, 212, 0.8); }
}
@keyframes cornerPulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
.scan-status { padding: 14px; border-radius: 12px; transition: all .25s ease; font-weight:700; }
.scan-status.waiting { background:#fef3c7; border:2px solid #fbbf24; color:#92400e; }
.scan-status.success { background:#ecfdf5; border:2px solid #10b981; color:#065f46; animation: pulse-success 1.6s infinite; }
.scan-status.error { background:#fef2f2; border:2px solid #ef4444; color:#991b1b; }
@keyframes pulse-success { 0%{ transform: scale(1); } 50%{ transform: scale(1.02);} 100%{ transform: scale(1); } }
.scan-status.waiting { animation: pulse 2s infinite; }
button#startBorrowRfidScanBtn { font-weight:800; border-radius:12px; padding: 14px 20px;}
#borrowerInfo { transition: transform .28s ease, opacity .28s ease; }
dialog[open] { backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
</style>
<div class="page-header">
  <h1>üìñ Borrow Item</h1>
  <p>Scan RFID card and item QR code to borrow an item</p>
</div>

<div class="content-card gradient-warm-orange">
<!-- Main Action Buttons -->
<div style="display: flex; gap: 20px; margin-bottom: 40px;">
  <!-- Button 1: Scan RFID -->
  <button id="scanIdBtn" type="button" class="btn btn-primary btn-lg" onclick="handleScanIdClick()" style="flex: 1; height: 80px; font-size: 18px; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 12px; background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%); border: 2px solid #e5e7eb; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
    <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
    <span class="btn-text" style="white-space: nowrap;">Scan ID (RFID)</span>
  </button>

  <!-- Button 2: Scan QR Code -->
  <button id="scanQrBtn" type="button" class="btn btn-secondary btn-lg" onclick="handleScanQrClick()" style="flex: 1; height: 80px; font-size: 18px; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 12px; background: linear-gradient(135deg, #374151 0%, #1f2937 100%); border: 2px solid #374151; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); color: white;">
    <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
    <span class="btn-text" style="white-space: nowrap;">Scan Item QR Code</span>
  </button>
</div>
</div>

  <dialog id="borrowToast"></dialog>

  <dialog id="rfidScanModal" style="border: none; border-radius: 20px; padding: 0; max-width: 90%; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 0; border-radius: 20px; display: flex; flex-direction: column; height: 100%;">
      <!-- Modal Header -->
      <div style="padding: 28px 28px 20px; background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%); border-bottom: 2px solid #fbbf24;">
        <h2 style="margin: 0; font-size: 24px; font-weight: 800; color: #92400e; letter-spacing: 0.5px;">üì± Start RFID Scan</h2>
        <p style="margin: 8px 0 0 0; color: #b45309; font-size: 14px;">Tap your school ID card to the reader</p>
      </div>

      <!-- Modal Content -->
      <div style="padding: 32px 28px; flex: 1; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; gap: 24px; min-height: 0; max-height: calc(90vh - 200px);">
        <!-- Input Field -->
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <label style="font-weight: 700; color: #92400e; font-size: 16px;">Student RFID Card</label>
          <input id="borrowerRfid" class="mono" type="text" placeholder="Tap RFID card" required style="padding: 16px; font-size: 16px; border: 2px solid #fbbf24; border-radius: 12px; background: white; color: #1f2937; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);" readonly />
        </div>

        <!-- Start Button -->
        <button type="button" id="startBorrowRfidScanBtn" class="btn btn-primary btn-lg" style="width: 100%; height: 70px; font-size: 18px; font-weight: 800; background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%); color: #1f2937; border: 2px solid #fbbf24; border-radius: 14px; box-shadow: 0 6px 20px rgba(251, 191, 36, 0.3); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px;">
          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span style="font-weight: 800; white-space: nowrap;">Start RFID Scan</span>
        </button>

        <!-- Status Message -->
        <div class="scan-status waiting" id="rfidStatus" style="padding: 16px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; color: #92400e; font-weight: 600; text-align: center; font-size: 15px; animation: pulse 2s infinite;">
          üëâ Click "Start RFID Scan" button, then tap the card...
        </div>

        <!-- Borrower Info (Hidden initially) -->
        <div id="borrowerInfo" class="hidden" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 14px; border: 2px solid #93c5fd; animation: slideUp 0.4s ease;">
          <div style="font-weight: 700; color: #0c4a6e; font-size: 16px; margin-bottom: 12px;">‚úÖ Student Information</div>
          <div id="borrowerDetails" style="color: #0c4a6e; font-weight: 600;"></div>
        </div>

        <!-- Confirm Button (Hidden initially) -->
        <div id="rfidConfirmSection" class="hidden" style="animation: slideUp 0.4s ease;">
          <button type="button" id="confirmRfidBtn" class="btn btn-success btn-lg" style="width: 100%; height: 70px; font-size: 18px; font-weight: 800; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: 2px solid #10b981; border-radius: 14px; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 12px;">
            <svg width="24" height="24" fill="none" stroke="white" viewBox="0 0 24 24" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            <span style="font-weight: 800; white-space: nowrap;">Confirm Borrower</span>
          </button>
        </div>
      </div>

      <!-- Modal Footer -->
      <div style="padding: 20px 28px; border-top: 2px solid #fbbf24; background: #fef3c7; display: flex; gap: 12px; flex-shrink: 0;">
        <button type="button" id="backFromRfid" class="btn btn-secondary btn-lg" style="flex: 1; height: 55px; font-size: 16px; font-weight: 700; background: linear-gradient(135deg, #374151 0%, #1f2937 100%); border: 2px solid #4b5563; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 10px;">
          <svg width="20" height="20" fill="none" stroke="white" viewBox="0 0 24 24" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
          <span style="white-space: nowrap;">Back</span>
        </button>
      </div>
    </div>
  </dialog>

  <!-- QR Code Scan Modal -->
  <dialog id="qrScanModal" style="border: none; border-radius: 20px; padding: 0; max-width: 90%; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="background: linear-gradient(135deg, #cffafe 0%, #a5f3fc 100%); padding: 0; border-radius: 20px; display: flex; flex-direction: column; height: 100%;">
      <!-- Modal Header -->
      <div style="padding: 20px 24px; background: linear-gradient(135deg, #a5f3fc 0%, #67e8f9 100%); border-bottom: 2px solid #06b6d4;">
        <h2 style="margin: 0; font-size: 22px; font-weight: 800; color: #164e63; letter-spacing: 0.5px;">üì∑ Scan Item QR Code</h2>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px 24px; flex: 1; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; gap: 16px; min-height: 0; max-height: calc(90vh - 160px);">
        <!-- QR Reader Container Wrapper -->
        <div style="position: relative; display: flex; flex-direction: column;">
          <!-- Corner brackets overlay -->
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 30; border-radius: 14px;">
            <div class="qr-corner top-left"></div>
            <div class="qr-corner top-right"></div>
            <div class="qr-corner bottom-left"></div>
            <div class="qr-corner bottom-right"></div>
          </div>
          <!-- QR Reader Container -->
          <div id="qr-reader" style="width: 100%; border: none; border-radius: 14px; overflow: hidden; background: #000; min-height: 280px; position: relative;">
          </div>
        </div>

        <!-- QR Status Message -->
        <div id="qrStatus" style="padding: 12px; border-radius: 12px; font-weight: 700; font-size: 13px; text-align: center; color: #164e63; background: #cffafe; border: 2px solid #06b6d4; min-height: 20px;">üì∑ Starting camera...</div>

        <!-- Camera Permission Help (Hidden initially) -->
        <div id="cameraPermissionHelp" class="hidden" style="background: #fef3c7; padding: 12px; border-radius: 12px; border-left: 4px solid #f59e0b;">
          <div style="font-weight: 700; color: #92400e; font-size: 13px; margin-bottom: 8px;">Camera access needed</div>
          <button type="button" id="retryCamera" class="btn btn-primary btn-lg" style="width: 100%; height: 45px; font-size: 14px; font-weight: 700; border-radius: 10px; background: #06b6d4; border: none; color: white; cursor: pointer;">üîÑ Enable Camera</button>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="borrowToast"></dialog>

  <!-- Borrow Confirmation Dialog -->
  <dialog id="borrowConfirmDialog" style="border: none; border-radius: 20px; padding: 0; max-width: 90%; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 0; border-radius: 20px; display: flex; flex-direction: column; height: 100%;">
      <!-- Modal Header -->
      <div style="padding: 28px 28px 20px; background: linear-gradient(135deg, #a7f3d0 0%, #6ee7b7 100%); border-bottom: 2px solid #10b981;">
        <h2 style="margin: 0; font-size: 24px; font-weight: 800; color: #065f46; letter-spacing: 0.5px;">‚úÖ Confirm Borrow</h2>
        <p style="margin: 8px 0 0 0; color: #047857; font-size: 14px;">Please verify the borrower and item details</p>
      </div>

      <!-- Modal Content -->
      <div style="padding: 32px 28px; flex: 1; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; gap: 20px; min-height: 0;">
        <!-- Borrower Info -->
        <div style="background: white; padding: 20px; border-radius: 14px; border-left: 4px solid #10b981;">
          <div style="font-weight: 700; color: #065f46; font-size: 16px; margin-bottom: 12px;">üë§ Borrower Information</div>
          <div id="confirmBorrowerName" style="color: #047857; font-weight: 600; margin-bottom: 6px;">Name: [Loading...]</div>
          <div id="confirmBorrowerRfid" style="color: #047857; font-weight: 600; font-family: monospace;">RFID: [Loading...]</div>
        </div>

        <!-- Item Info -->
        <div style="background: white; padding: 20px; border-radius: 14px; border-left: 4px solid #0284c7;">
          <div style="font-weight: 700; color: #0c4a6e; font-size: 16px; margin-bottom: 12px;">üì¶ Item Information</div>
          <div id="confirmItemName" style="color: #0c4a6e; font-weight: 600; margin-bottom: 6px;">Item: [Loading...]</div>
          <div id="confirmItemQr" style="color: #0c4a6e; font-weight: 600; font-family: monospace; margin-bottom: 6px;">QR Code: [Loading...]</div>
          <div id="confirmItemDesc" style="color: #0c4a6e; font-size: 14px;">Description: [Loading...]</div>
        </div>

        <!-- Custom message area -->
        <div id="confirmBorrowMessage" style="background: #f0f9ff; padding: 16px; border-radius: 12px; border-left: 4px solid #3b82f6;"></div>
      </div>

      <!-- Modal Footer -->
      <div style="padding: 20px 28px; border-top: 2px solid #10b981; background: #ecfdf5; display: flex; gap: 12px; flex-shrink: 0;">
        <button type="button" id="cancelBorrowBtn" class="btn btn-secondary btn-lg" style="flex: 1; height: 55px; font-size: 16px; font-weight: 700; background: linear-gradient(135deg, #374151 0%, #1f2937 100%); border: 2px solid #4b5563; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 10px;">
          <svg width="20" height="20" fill="none" stroke="white" viewBox="0 0 24 24" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          <span style="white-space: nowrap;">Cancel</span>
        </button>
        <button type="button" id="confirmBorrowBtn" class="btn btn-success btn-lg" style="flex: 1; height: 55px; font-size: 16px; font-weight: 700; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: 2px solid #10b981; border-radius: 12px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); transition: all 0.3s ease; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 10px;">
          <svg width="20" height="20" fill="none" stroke="white" viewBox="0 0 24 24" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
          <span style="white-space: nowrap;">Confirm Borrow</span>
        </button>
      </div>
    </div>
  </dialog>
  
  <!-- Hidden form for CSRF token -->
  <form id="csrfForm" style="display: none;">
    {% csrf_token %}
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// GLOBAL HANDLERS - Must be at top
window.handleScanIdClick = function() {
    console.log('%cüéØ handleScanIdClick CALLED', 'font-size: 16px; color: blue; font-weight: bold;');
    try {
      const modal = document.getElementById('rfidScanModal');
      if (!modal) {
        console.error('%c‚ùå rfidScanModal element NOT FOUND', 'font-size: 14px; color: red;');
        return;
      }
      
      console.log('%c‚úÖ Modal found, opening now...', 'font-size: 14px; color: green;');
      
      // Reset RFID state before opening
      window.scannedRfid = '';
      window.borrowerData = null;
      window.borrowLastScanId = null;
      window.rfidProcessing = false;
      
      modal.showModal();
      console.log('%c‚úÖ modal.showModal() succeeded', 'font-size: 14px; color: green;');
      
      // Add small delay to ensure modal is rendered
      setTimeout(() => {
        if (typeof startBorrowRfidScan === 'function') {
          startBorrowRfidScan();
          console.log('%c‚úÖ startBorrowRfidScan() called', 'font-size: 14px; color: green;');
        } else {
          console.error('%c‚ùå startBorrowRfidScan function NOT FOUND', 'font-size: 14px; color: red;');
        }
      }, 100);
    } catch (err) {
      console.error('%c‚ùå ERROR:', 'font-size: 14px; color: red; font-weight: bold;', err);
    }
  };

  window.handleScanQrClick = function() {
    console.log('%cüéØ handleScanQrClick CALLED', 'font-size: 16px; color: blue; font-weight: bold;');
    try {
      const modal = document.getElementById('qrScanModal');
      if (!modal) {
        console.error('%c‚ùå qrScanModal element NOT FOUND', 'font-size: 14px; color: red;');
        return;
      }
      
      console.log('%c‚úÖ Modal found, opening now...', 'font-size: 14px; color: green;');
      
      modal.showModal();
      console.log('%c‚úÖ modal.showModal() succeeded', 'font-size: 14px; color: green;');
      
      // Add small delay to ensure modal is rendered
      setTimeout(() => {
        if (typeof startQrScanner === 'function') {
          startQrScanner();
          console.log('%c‚úÖ startQrScanner() called', 'font-size: 14px; color: green;');
        } else {
          console.error('%c‚ùå startQrScanner function NOT FOUND', 'font-size: 14px; color: red;');
        }
      }, 100);
    } catch (err) {
      console.error('%c‚ùå ERROR:', 'font-size: 14px; color: red; font-weight: bold;', err);
    }
  };

  const apiBase = '/api';
  let qrScanner = null;

  // Detect if browser supports secure context (HTTPS/localhost)
  const isSecureContext = window.isSecureContext || window.location.protocol === 'https:';
  
  // Handle photo capture from file input (works on HTTP)
  document.getElementById('qrPhotoInput')?.addEventListener('change', async function(e) {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      const reader = new FileReader();
      reader.onload = async (event) => {
        const imageData = event.target?.result;
        if (!imageData || typeof imageData !== 'string') return;

        try {
          document.getElementById('qrStatus').textContent = 'üîç Scanning photo for QR code...';
          document.getElementById('qrStatus').className = 'scan-status waiting';

          // Use Html5Qrcode to scan the photo
          const result = await Html5Qrcode.scanFile(imageData, false);
          if (result) {
            scannedQr = result.trim();
            document.getElementById('qrStatus').textContent = `‚úÖ QR Code found: ${scannedQr}`;
            document.getElementById('qrStatus').className = 'scan-status success';

            // Fetch item details and show confirmation
            try {
              await fetchItemDetailsAndShowConfirmation(scannedQr);
            } catch(err) {
              console.error('Error fetching item details:', err);
              document.getElementById('qrStatus').textContent = '‚ùå Item not found. Try another photo.';
              document.getElementById('qrStatus').className = 'scan-status error';
            }

            // Close modal after successful scan
            setTimeout(() => {
              const qrModal = document.getElementById('qrScanModal');
              if (qrModal && qrModal.open) qrModal.close();
            }, 1500);
          }
        } catch (err) {
          console.error('QR scan error:', err);
          document.getElementById('qrStatus').textContent = '‚ùå No QR code found in photo. Try another angle.';
          document.getElementById('qrStatus').className = 'scan-status error';
        }
      };
      reader.readAsDataURL(file);
    } catch (err) {
      console.error('Photo processing error:', err);
      document.getElementById('qrStatus').textContent = '‚ùå Could not process photo. Try again.';
      document.getElementById('qrStatus').className = 'scan-status error';
    }

    // Reset input so same file can be selected again
    e.target.value = '';
  });
  let scannedRfid = '';
  let scannedQr = '';
  let rfidProcessing = false;
  let borrowerData = null;
  let lastScanId = null;
  const csrfToken = document.querySelector('#csrfForm [name=csrfmiddlewaretoken]')?.value;
  
  // RFID scanning state variables - MUST be declared early
  let borrowPollInterval = null;
  let isBorrowScanning = false;
  let borrowLastScanId = null;
  
  // Auto-scan flow state
  let scanningFlow = {
    borrowerData: null,
    scannedRfid: null,
    rfidValidated: false,
    autoOpenQrModal: false
  };

  function showToast(dialog, message) {
    dialog.textContent = message;
    dialog.showModal();
    setTimeout(() => dialog.close(), 2200);
  }


  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function fetchItemDetailsAndShowConfirmation(qrCode) {
    try {
      console.log('üì° Fetching item details for QR:', qrCode);
      const res = await fetch(`${apiBase}/items?q=${encodeURIComponent(qrCode)}`);
      
      if (!res.ok) {
        throw new Error(`Server error: ${res.status}`);
      }
      
      const items = await res.json();
      console.log('üì¶ Items response:', items);
      
      if (!Array.isArray(items) || items.length === 0) {
        console.log('‚ùå No items found in response');
        showToast(document.getElementById('borrowToast'), '‚ùå Item QR code not found in system');
        scannedQr = '';
        qrScannerProcessing = false;
        return;
      }
      
      // Find exact match
      const item = items.find(i => i.qr_code && i.qr_code.toUpperCase() === qrCode.toUpperCase());
      
      if (item) {
        console.log('‚úÖ Item found:', item.name);
        
        // Check if item is already borrowed
        if (item.current_borrower || item.borrowed_by) {
          console.log('‚ö†Ô∏è Item already borrowed by:', item.current_borrower || item.borrowed_by);
          showToast(document.getElementById('borrowToast'), `‚ö†Ô∏è "${item.name}" is already borrowed. Please return it first.`);
          scannedQr = '';
          qrScannerProcessing = false;
          return;
        }
        
        // Check if borrower RFID has been scanned
        if (!scannedRfid || !borrowerData) {
          console.log('‚ö†Ô∏è RFID not scanned yet');
          showToast(document.getElementById('borrowToast'), '‚ö†Ô∏è Please scan the student ID card first, then scan the item QR code');
          scannedQr = '';
          qrScannerProcessing = false;
          // Auto-open RFID modal for user
          const rfidModal = document.getElementById('rfidScanModal');
          if (rfidModal) rfidModal.showModal();
          return;
        }
        
        // Update confirmation dialog
        document.getElementById('confirmBorrowerName').textContent = borrowerData?.name || scannedRfid;
        document.getElementById('confirmBorrowerRfid').textContent = scannedRfid;
        document.getElementById('confirmItemName').textContent = item.name || 'Unknown Item';
        document.getElementById('confirmItemQr').textContent = scannedQr;
        document.getElementById('confirmItemDesc').textContent = item.description || 'No description';
        
        // Show confirmation dialog
        const confirmDialog = document.getElementById('borrowConfirmDialog');
        confirmDialog.showModal();
      } else {
        console.log('‚ùå Item QR not found in results');
        showToast(document.getElementById('borrowToast'), '‚ùå Item QR code not found in system');
        scannedQr = '';
        qrScannerProcessing = false;
      }
    } catch (err) {
      console.error('Error fetching item:', err);
      showToast(document.getElementById('borrowToast'), '‚ùå Error: ' + (err.message || 'Could not fetch item details'));
      scannedQr = '';
      qrScannerProcessing = false;
      document.getElementById('qrStatus').textContent = 'üì∑ Camera active. Point at QR code...';
      document.getElementById('qrStatus').className = 'scan-status waiting';
    }
  }

  async function borrowAction(evt) {
    evt.preventDefault();
    const toast = document.getElementById('borrowToast');
    if (!scannedRfid || !scannedQr) {
      showToast(toast, 'Please scan both RFID and QR code');
      return;
    }
    
    // Show confirmation modal
    const borrowerName = borrowerData?.name || scannedRfid;
    const borrowerRfid = scannedRfid;
    document.getElementById('borrowConfirmMessage').innerHTML = `
      <div style="text-align: left; margin-top: 12px;">
        <div style="margin-bottom: 16px;">
          <strong>Borrower:</strong><br>
          <span style="font-size: 1.1rem; color: #10b981;">${escapeHtml(borrowerName)}</span><br>
          <span class="mono" style="font-size: 0.9rem; color: #64748b;">${escapeHtml(borrowerRfid)}</span>
        </div>
        <div>
          <strong>Item QR Code:</strong><br>
          <span class="mono" style="font-size: 1.2rem; color: #10b981; word-break: break-all;">${escapeHtml(scannedQr)}</span>
        </div>
      </div>
    `;
    
    const confirmDialog = document.getElementById('borrowConfirmDialog');
    const confirmBtn = document.getElementById('confirmBorrowBtn');
    const cancelBtn = document.getElementById('cancelBorrowBtn');
    
    // Remove old listeners
    const newConfirmBtn = confirmBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    newConfirmBtn.onclick = async () => {
      confirmDialog.close();
      try {
        const tokenToSend = csrfToken || (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '';
        if (!tokenToSend) console.warn('No CSRF token found for borrow');
        const res = await fetch(`${apiBase}/borrow`, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': tokenToSend
          },
          body: JSON.stringify({ borrower_rfid: scannedRfid, item_qr: scannedQr })
        });
        if (res.status === 403) console.error('Borrow 403; csrftoken cookie=', (document.cookie.match(/csrftoken=([^;]+)/)||[])[1], 'sent header=', tokenToSend);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || 'Borrow failed');
        showToast(toast, '‚úÖ Borrowed successfully! Redirecting...');
        setTimeout(() => {
          window.location.href = "{% url 'core:dashboard' %}";
        }, 1500);
      } catch (e) {
        showToast(toast, '‚ùå ' + (e.message || 'Error'));
      }
    };
    
    newCancelBtn.onclick = () => {
      confirmDialog.close();
    };
    
    confirmDialog.showModal();
  }

  function resetBorrowFlow() {
    scannedRfid = '';
    scannedQr = '';
    borrowerData = null;
    borrowLastScanId = null;
    rfidProcessing = false;
    document.getElementById('borrowerRfid').value = '';
    document.getElementById('borrowerRfid').readOnly = true;
    document.getElementById('rfidStatus').textContent = 'Click "Start RFID Scan" button, then tap the card...';
    document.getElementById('rfidStatus').className = 'scan-status waiting';
    document.getElementById('borrowerInfo').classList.add('hidden');
    document.getElementById('borrowerDetails').innerHTML = '';
    document.getElementById('rfidConfirmSection').classList.add('hidden');
    stopBorrowRfidScan();
    // Don't stop QR scanner - keep it running for next scan
    showStep(1);
  }
  
  async function checkBorrowerRegistration(rfid) {
    try {
      const res = await fetch(`${apiBase}/borrowers?q=${encodeURIComponent(rfid)}`);
      const borrowers = await res.json();
      
      // Find exact match (case-insensitive)
      const borrower = borrowers.find(b => 
        b.rfid_uid && b.rfid_uid.toUpperCase() === rfid.toUpperCase()
      );
      
      return borrower || null;
    } catch (e) {
      console.error('Error checking borrower:', e);
      return null;
    }
  }

  let qrScannerProcessing = false; // Flag to prevent duplicate processing
  
  async function startQrScanner(usePhoneCameraUrl = null) {
    try {
      const qrReader = document.getElementById('qr-reader');
      console.log('üé¨ startQrScanner called, isSecureContext:', isSecureContext);
      
      // Clear previous scanner content
      qrReader.innerHTML = '';
      
      // If using phone camera URL, create video element and scan frames
      if (usePhoneCameraUrl) {
        document.getElementById('qrStatus').textContent = 'üì∑ Connecting to phone camera...';
        document.getElementById('qrStatus').className = 'scan-status waiting';
        
        // Create video element to play the stream
        const video = document.createElement('video');
        video.src = usePhoneCameraUrl;
        video.autoplay = true;
        video.playsInline = true;
        video.style.width = '100%';
        video.style.borderRadius = '12px';
        video.style.display = 'block';
        
        qrReader.appendChild(video);
        
        // Create canvas to capture frames
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        qrScanner = new Html5Qrcode('qr-reader');
        let scanInterval = null;
        
        video.onloadedmetadata = () => {
          // Set canvas dimensions based on video
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          video.play();
          document.getElementById('qrStatus').textContent = 'üì∑ Phone camera ready. Point at QR code...';
          document.getElementById('qrStatus').className = 'scan-status waiting';
          
          // Start scanning frames
          scanInterval = setInterval(async () => {
            if (video.readyState === video.HAVE_ENOUGH_DATA && !scannedQr) {
              try {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/png');
                
                const result = await qrScanner.scanFile(imageData, false);
                if (result) {
                  scannedQr = result.trim();
                  clearInterval(scanInterval);
                  document.getElementById('qrStatus').textContent = `‚úÖ QR Code scanned: ${scannedQr}`;
                  document.getElementById('qrStatus').className = 'scan-status success';
                  video.pause();

                  // Stop scanner and clear references
                  try { clearInterval(scanInterval); } catch(e) {}
                  try { qrScanner._video = null; } catch(e) {}

                  // Immediately show item details / confirmation (same behavior as return page)
                  try {
                    await fetchItemDetailsAndShowConfirmation(scannedQr);
                  } catch(e) {
                    console.error('Error fetching item details:', e);
                  }

                  // Close QR modal when an item is found or after scan
                  const qrModal = document.getElementById('qrScanModal');
                  if (qrModal && qrModal.open) qrModal.close();
                }
              } catch (e) {
                // No QR code found, continue scanning
              }
            }
          }, 500); // Scan every 500ms
          
          // Store interval to clear it later
          qrScanner._scanInterval = scanInterval;
          qrScanner._video = video;
        };
        
        video.onerror = () => {
          document.getElementById('qrStatus').textContent = '‚ùå Could not connect to phone camera. Check the URL and ensure IP Webcam is running.';
          document.getElementById('qrStatus').className = 'scan-status error';
        };
        
        return;
      }
      
      // Regular camera access - only on HTTPS
      if (!isSecureContext) {
        console.log('‚ö†Ô∏è Not secure context, showing HTTPS required message');
        document.getElementById('qrStatus').innerHTML = '‚ö†Ô∏è <strong>Live camera requires HTTPS.</strong><br/>Use the photo capture option above instead.';
        document.getElementById('qrStatus').className = 'scan-status error';
        document.getElementById('qr-reader').innerHTML = '<div style="padding: 40px; text-align: center; color: #f5f5f5; font-size: 14px;"><p style="margin: 0;">üì∏ Live camera access requires HTTPS</p><p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.7;">Use the photo capture option instead</p></div>';
        return;
      }

      // Check camera permissions
      try {
        console.log('üé• Requesting camera permissions...');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop()); // Stop immediately, we just wanted to check
        document.getElementById('cameraPermissionHelp').classList.add('hidden');
        console.log('‚úÖ Camera permissions granted');
      } catch (permErr) {
        console.error('‚ùå Camera permission error:', permErr);
        document.getElementById('qrStatus').textContent = '‚ùå Camera permission denied. Please allow camera access.';
        document.getElementById('qrStatus').className = 'scan-status error';
        document.getElementById('cameraPermissionHelp').classList.remove('hidden');
        return;
      }
      
      document.getElementById('qrStatus').textContent = 'üì∑ Starting camera...';
      document.getElementById('qrStatus').className = 'scan-status waiting';
      
      // Get available cameras
      console.log('üîç Enumerating cameras...');
      let cameras = [];
      try {
        cameras = await Html5Qrcode.getCameras();
        console.log('üìπ Found cameras:', cameras);
      } catch (e) {
        console.error('‚ùå Error enumerating cameras:', e);
        cameras = [];
      }
      
      if (!cameras || cameras.length === 0) {
        console.error('‚ùå No cameras found');
        document.getElementById('qrStatus').textContent = '‚ùå No camera found on this device.';
        document.getElementById('qrStatus').className = 'scan-status error';
        document.getElementById('qr-reader').innerHTML = '<div style="padding: 40px; text-align: center; color: #f5f5f5;"><p>No camera found</p></div>';
        return;
      }

      // Create scanner instance
      console.log('üì± Creating Html5Qrcode instance...');
      qrScanner = new Html5Qrcode('qr-reader');
      
      // Calculate qrbox size - larger for better detection
      const readerWidth = qrReader.clientWidth || Math.floor(qrReader.getBoundingClientRect().width) || Math.floor(window.innerWidth * 0.8);
      const qrboxSize = Math.min(320, readerWidth - 10);
      
      const scanConfig = {
        fps: 25,
        qrbox: { width: qrboxSize, height: qrboxSize },
        disableFlip: false,
        rememberLastUsedCamera: true,
        aspectRatio: 1.0
      };
      
      // Try with different camera configurations for laptop
      let cameraConfig = { facingMode: 'environment' };
      
      console.log('üé¨ Starting scanner with config:', scanConfig);

      // Start scanning with camera
      try {
        qrScannerProcessing = false; // Reset processing flag
        
        try {
          await qrScanner.start(
            cameraConfig,
            scanConfig,
            async (decodedText, decodedResult) => {
              if (qrScannerProcessing) return;
              if (!decodedText || decodedText.trim().length === 0) return;
              
              if (scannedQr === decodedText.trim()) return;
              
              qrScannerProcessing = true;
              scannedQr = decodedText.trim();
              console.log('‚úÖ QR Code scanned:', scannedQr);
              
              document.getElementById('qrStatus').textContent = `‚úÖ QR Code found: ${scannedQr}`;
              document.getElementById('qrStatus').className = 'scan-status success';
              
              // Stop scanner
              if (qrScanner) {
                try { 
                  qrScanner.stop().then(() => {
                    if (qrScanner && qrScanner.clear) qrScanner.clear();
                    qrScanner = null;
                  }).catch(() => {
                    qrScanner = null;
                  }); 
                } catch(e) { console.error('Error stopping scanner:', e); qrScanner = null; }
              }

              // Close the QR modal
              const qrModal = document.getElementById('qrScanModal');
              if (qrModal && qrModal.open) {
                qrModal.close();
              }

              // Fetch item details
              try {
                await fetchItemDetailsAndShowConfirmation(scannedQr);
              } catch(e) {
                console.error('Error fetching item details:', e);
                showToast(document.getElementById('borrowToast'), '‚ùå Error: ' + (e.message || 'Could not fetch item details'));
                qrScannerProcessing = false;
                scannedQr = null;
                setTimeout(() => {
                  if (qrScanner) {
                    try { qrScanner.stop().catch(() => {}); } catch(e) {}
                  }
                  startQrScanner();
                }, 2000);
              }
            },
            (errorMessage) => {
              // Ignore scanning errors
            }
          );
          console.log('‚úÖ Scanner started successfully');
          document.getElementById('qrStatus').textContent = 'üì∑ Camera active. Point at QR code...';
          document.getElementById('qrStatus').className = 'scan-status waiting';
        } catch (startErr) {
          // If environment camera fails, try without facingMode (fallback for laptops)
          console.log('Environment camera failed, trying fallback config...');
          if (startErr.name === 'NotReadableError' || startErr.name === 'ConstraintNotSatisfiedError') {
            try {
              await qrScanner.start(
                {},
                scanConfig,
                async (decodedText, decodedResult) => {
                  if (qrScannerProcessing) return;
                  if (!decodedText || decodedText.trim().length === 0) return;
                  
                  if (scannedQr === decodedText.trim()) return;
                  
                  qrScannerProcessing = true;
                  scannedQr = decodedText.trim();
                  console.log('‚úÖ QR Code scanned:', scannedQr);
                  
                  document.getElementById('qrStatus').textContent = `‚úÖ QR Code found: ${scannedQr}`;
                  document.getElementById('qrStatus').className = 'scan-status success';
                  
                  if (qrScanner) {
                    try { 
                      qrScanner.stop().then(() => {
                        if (qrScanner && qrScanner.clear) qrScanner.clear();
                        qrScanner = null;
                      }).catch(() => {
                        qrScanner = null;
                      }); 
                    } catch(e) { console.error('Error stopping scanner:', e); qrScanner = null; }
                  }

                  // Close the QR modal
                  const qrModal = document.getElementById('qrScanModal');
                  if (qrModal && qrModal.open) {
                    qrModal.close();
                  }

                  try {
                    await fetchItemDetailsAndShowConfirmation(scannedQr);
                  } catch(e) {
                    console.error('Error fetching item details:', e);
                    showToast(document.getElementById('borrowToast'), '‚ùå Error: ' + (e.message || 'Could not fetch item details'));
                    qrScannerProcessing = false;
                    scannedQr = null;
                    setTimeout(() => {
                      if (qrScanner) {
                        try { qrScanner.stop().catch(() => {}); } catch(e) {}
                      }
                      startQrScanner();
                    }, 2000);
                  }
                },
                (errorMessage) => {}
              );
              console.log('‚úÖ Fallback scanner started');
              document.getElementById('qrStatus').textContent = 'üì∑ Camera active. Point at QR code...';
              document.getElementById('qrStatus').className = 'scan-status waiting';
            } catch (fallbackErr) {
              throw fallbackErr;
            }
          } else {
            throw startErr;
          }
        }
      } catch (err) {
        let errorMsg = 'Camera error: ';
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
          errorMsg = '‚ùå Camera permission denied. Please allow camera access and try again.';
        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
          errorMsg = '‚ùå No camera found. Please connect a camera device.';
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
          errorMsg = '‚ùå Camera is already in use by another application.';
        } else if (err.message) {
          errorMsg = '‚ùå Camera error: ' + err.message;
        } else if (err.toString) {
          errorMsg = '‚ùå Camera error: ' + err.toString();
        } else {
          errorMsg = '‚ùå Unable to access camera. Please check your browser settings and try again.';
        }
        document.getElementById('qrStatus').textContent = errorMsg;
        document.getElementById('qrStatus').className = 'scan-status error';
      }
    } catch (outerErr) {
      console.error('Outer error in startQrScanner:', outerErr);
      document.getElementById('qrStatus').textContent = '‚ùå Unexpected error starting scanner';
      document.getElementById('qrStatus').className = 'scan-status error';
    }
  }
  
  // Phone camera handler (if element exists)
  const usePhoneCameraBtn = document.getElementById('usePhoneCamera');
  if (usePhoneCameraBtn) {
    usePhoneCameraBtn.addEventListener('click', () => {
      const phoneUrl = document.getElementById('phoneCameraUrl').value.trim();
      if (!phoneUrl) {
        alert('Please enter a phone camera stream URL (e.g., http://192.168.1.XXX:8080/video)');
        return;
      }
      startQrScanner(phoneUrl);
    });
  }

  function stopQrScanner() {
    if (qrScanner) {
      // Clear interval if using phone camera
      if (qrScanner._scanInterval) {
        clearInterval(qrScanner._scanInterval);
      }
      if (qrScanner._video) {
        qrScanner._video.pause();
        qrScanner._video.src = '';
      }
      qrScanner.stop().then(() => {
        qrScanner.clear();
        qrScanner = null;
        document.getElementById('qr-reader').innerHTML = '';
        document.getElementById('qrStatus').textContent = 'Camera stopped';
        document.getElementById('qrStatus').className = 'scan-status';
      }).catch(() => {});
    }
  }

  // Attach form submit handler if form exists
  const borrowForm = document.getElementById('borrowForm');
  if (borrowForm) {
    borrowForm.addEventListener('submit', borrowAction);
  }
  
  // QR Modal - Retry camera button
  document.getElementById('retryCamera').addEventListener('click', () => {
    startQrScanner();
  });

  // QR Modal - Close when clicking outside or pressing ESC
  const qrScanModal = document.getElementById('qrScanModal');
  qrScanModal?.addEventListener('click', (e) => {
    console.log('üñ±Ô∏è Click on QR modal backdrop detected');
    if (e.target === qrScanModal) {
      console.log('üì≠ Closing QR modal via backdrop click');
      qrScanModal.close();
      stopQrScanner();
    }
  });

  qrScanModal?.addEventListener('close', () => {
    console.log('üì≠ QR modal close event fired');
    stopQrScanner();
  });

  // Reset borrow flow button (if it exists)
  const resetBorrowBtn = document.getElementById('resetBorrow');
  if (resetBorrowBtn) {
    resetBorrowBtn.addEventListener('click', () => {
      resetBorrowFlow();
    });
  }
  
  async function processRfidScan(rfid) {
    if (!rfid || rfid.length < 4 || rfidProcessing) return;
    
    rfidProcessing = true;
    scannedRfid = rfid.trim();
    const statusEl = document.getElementById('rfidStatus');
    const borrowerInfoEl = document.getElementById('borrowerInfo');
    const borrowerDetailsEl = document.getElementById('borrowerDetails');
    const rfidInput = document.getElementById('borrowerRfid');
    const confirmSection = document.getElementById('rfidConfirmSection');
    
    // Update input field
    rfidInput.value = scannedRfid;
    rfidInput.readOnly = false; // Allow editing after scan
    stopBorrowRfidScan(); // Stop scanning
    
    statusEl.textContent = 'Checking borrower registration...';
    statusEl.className = 'scan-status waiting';
    borrowerInfoEl.classList.add('hidden');
    confirmSection.classList.add('hidden');
    
    // Check if borrower is registered
    borrowerData = await checkBorrowerRegistration(scannedRfid);
    
    if (borrowerData) {
      // Borrower is registered
      statusEl.textContent = '‚úÖ Borrower is registered! Opening item scanner...';
      statusEl.className = 'scan-status success';
      
      // Reset styling for registered borrower
      borrowerInfoEl.style.background = '#f0f9ff';
      borrowerInfoEl.style.borderLeftColor = '#0284c7';
      
      // Show borrower details
      borrowerDetailsEl.innerHTML = `
        <strong style="display: block; margin-bottom: 8px; color: #0c4a6e;">Borrower Information:</strong>
        <div style="color: #0c4a6e;">
          <div><strong>Name:</strong> ${borrowerData.name || 'N/A'}</div>
          <div><strong>RFID:</strong> <span class="mono">${borrowerData.rfid_uid}</span></div>
          ${borrowerData.email ? `<div><strong>Email:</strong> ${borrowerData.email}</div>` : ''}
        </div>
      `;
      borrowerInfoEl.classList.remove('hidden');
      confirmSection.classList.add('hidden'); // Hide confirm button - will auto-flow
      
      // Update flow state
      scanningFlow.borrowerData = borrowerData;
      scanningFlow.scannedRfid = scannedRfid;
      scanningFlow.rfidValidated = true;
      
      // AUTO-OPEN QR MODAL after 2 seconds to show borrower info
      setTimeout(() => {
        console.log('üîÑ Auto-opening QR modal for auto-scan flow...');
        const rfidModal = document.getElementById('rfidScanModal');
        const qrModal = document.getElementById('qrScanModal');
        
        if (rfidModal && rfidModal.open) {
          console.log('üì≠ Closing RFID modal');
          rfidModal.close();
        }
        
        // Open QR modal
        if (qrModal) {
          console.log('üì∑ Opening QR modal');
          qrModal.showModal();
          
          // Start QR scanner
          setTimeout(() => {
            console.log('üé¨ Starting QR scanner');
            startQrScanner();
          }, 300);
        }
      }, 2000);
      
      rfidProcessing = false;
    } else {
      // Borrower is NOT registered
      statusEl.textContent = '‚ùå Register the borrower first';
      statusEl.className = 'scan-status error';
      borrowerDetailsEl.innerHTML = `
        <strong style="display: block; margin-bottom: 8px; color: #991b1b;">Borrower Not Found:</strong>
        <div style="color: #991b1b;">
          <p style="margin: 8px 0;">RFID <span class="mono">${scannedRfid}</span> is not registered in the system.</p>
          <p style="margin: 8px 0;">Please register the borrower before attempting to borrow items.</p>
        </div>
      `;
      borrowerInfoEl.classList.remove('hidden');
      borrowerInfoEl.style.background = '#fef2f2';
      borrowerInfoEl.style.borderLeftColor = '#dc2626';
      rfidProcessing = false;
    }
  }
  
  // RFID scanning functions for borrow page
  async function pollBorrowRfidScan() {
    if (!isBorrowScanning) {
      console.log('üö´ Polling stopped: isBorrowScanning is false');
      return;
    }
    
    // Check if the modal is still open (rfidScanModal exists and is showing)
    const modal = document.getElementById('rfidScanModal');
    if (!modal) {
      console.log('üö´ Polling stopped: rfidScanModal element not found');
      stopBorrowRfidScan();
      return;
    }
    
    if (!modal.open) {
      console.log('üö´ Polling stopped: Modal is not open');
      stopBorrowRfidScan();
      return;
    }
    
    console.log('‚è≥ Polling for RFID scan...');
    
    try {
      const res = await fetch(`${apiBase}/rfid-scans`, { cache: 'no-store' });
      if (res.status === 204) {
        console.log('üì≠ No new RFID scan');
        return;
      }
      if (!res.ok) {
        console.log('‚ùå Polling error:', res.status);
        return;
      }
      const data = await res.json();
      if (!data || !data.id) {
        console.log('üì≠ No RFID data');
        return;
      }
      
      if (data.id === borrowLastScanId) {
        // same id, ignore
      } else {
        borrowLastScanId = data.id;
        console.log('üì± New RFID detected:', data.uid);
        if (data.uid && data.uid.trim().length >= 4) {
          const statusEl = document.getElementById('rfidStatus');
          if (statusEl) {
            statusEl.textContent = 'üì± Card detected: ' + data.uid;
            statusEl.className = 'scan-status success';
          }
          // Immediately process the RFID scan and avoid duplicate polling
          await processRfidScan(data.uid);
        }
      }
    } catch (err) {
      console.log('‚ö†Ô∏è Polling error:', err.message);
    }
  }
  
  function startBorrowRfidScan() {
    console.log('üöÄ startBorrowRfidScan called, isBorrowScanning:', isBorrowScanning);
    
    if (isBorrowScanning) {
      console.log('‚ö†Ô∏è Already scanning, ignoring duplicate call');
      return;
    }
    
    isBorrowScanning = true;
    const rfidInput = document.getElementById('borrowerRfid');
    const statusEl = document.getElementById('rfidStatus');
    const scanBtn = document.getElementById('startBorrowRfidScanBtn');
    
    console.log('üîß Resetting RFID scan state');
    rfidInput.value = '';
    rfidInput.readOnly = true;
    borrowLastScanId = null;
    scannedRfid = '';
    borrowerData = null;
    
    statusEl.textContent = 'üì± Scanning... Tap the RFID card now...';
    statusEl.className = 'scan-status waiting';
    scanBtn.textContent = '‚èπÔ∏è Stop Scanning';
    scanBtn.style.background = '#ef4444';
    document.getElementById('borrowerInfo').classList.add('hidden');
    document.getElementById('rfidConfirmSection').classList.add('hidden');
    
    console.log('üì° Fetching current RFID scan status');
    fetch(`${apiBase}/rfid-scans`, { cache: 'no-store' })
      .then(res => res.ok && res.status !== 204 ? res.json() : null)
      .then(data => {
        if (data && data.id) {
          borrowLastScanId = data.id;
          console.log('‚úÖ Current RFID scan ID set to:', data.id);
        }
        console.log('‚è±Ô∏è Starting polling interval (700ms)');
        pollBorrowRfidScan();
        borrowPollInterval = setInterval(pollBorrowRfidScan, 700);
      })
      .catch((err) => {
        console.log('‚ö†Ô∏è Fetch error (non-fatal):', err.message);
        console.log('‚è±Ô∏è Starting polling interval anyway (700ms)');
        pollBorrowRfidScan();
        borrowPollInterval = setInterval(pollBorrowRfidScan, 700);
      });
  }
  
  function stopBorrowRfidScan() {
    console.log('‚èπÔ∏è stopBorrowRfidScan called, isBorrowScanning:', isBorrowScanning);
    
    isBorrowScanning = false;
    if (borrowPollInterval) {
      console.log('üõë Clearing polling interval');
      clearInterval(borrowPollInterval);
      borrowPollInterval = null;
    }
    
    const scanBtn = document.getElementById('startBorrowRfidScanBtn');
    scanBtn.textContent = 'üì± Start RFID Scan';
    scanBtn.style.background = '';
    console.log('‚úÖ Scan stopped');
  }
  
  // Button inside modal: Start/Stop RFID scan
  document.getElementById('startBorrowRfidScanBtn').addEventListener('click', () => {
    console.log('üîò Start/Stop RFID button clicked, isBorrowScanning:', isBorrowScanning);
    if (isBorrowScanning) {
      stopBorrowRfidScan();
    } else {
      startBorrowRfidScan();
    }
  });
  
  document.getElementById('confirmRfidBtn').addEventListener('click', () => {
    console.log('‚úÖ Confirm RFID clicked');
    if (borrowerData && scannedRfid) {
      const modal = document.getElementById('rfidScanModal');
      if (modal && modal.open) {
        console.log('üì≠ Closing RFID modal');
        modal.close();
      }
      stopBorrowRfidScan();
      // Move to QR scanning - show QR modal or next step
      setTimeout(() => {
        console.log('üîÑ Opening QR scanner');
        document.getElementById('scanQrBtn').click();
      }, 300);
    } else {
      console.log('‚ö†Ô∏è Cannot confirm: missing borrower or RFID data');
    }
  });

  // Clear fields when going back from RFID modal
  document.getElementById('backFromRfid').addEventListener('click', () => {
    console.log('üëà Back from RFID modal clicked');
    stopBorrowRfidScan();
    scannedRfid = '';
    borrowerData = null;
    borrowLastScanId = null;
    rfidProcessing = false;
    document.getElementById('borrowerRfid').value = '';
    document.getElementById('borrowerRfid').readOnly = true;
    document.getElementById('rfidStatus').textContent = 'üëâ Click "Start RFID Scan" button, then tap the card...';
    document.getElementById('rfidStatus').className = 'scan-status waiting';
    document.getElementById('borrowerInfo').classList.add('hidden');
    document.getElementById('rfidConfirmSection').classList.add('hidden');
    
    const modal = document.getElementById('rfidScanModal');
    if (modal && modal.open) {
      console.log('Closing RFID modal');
      modal.close();
    }
  });

  // Confirmation Dialog Button Handlers
  const confirmBorrowBtn = document.getElementById('confirmBorrowBtn');
  const cancelBorrowBtn = document.getElementById('cancelBorrowBtn');
  
  if (confirmBorrowBtn) {
    confirmBorrowBtn.addEventListener('click', async () => {
      console.log('‚úÖ Confirm Borrow clicked');
      const confirmDialog = document.getElementById('borrowConfirmDialog');
      confirmDialog.close();
      
      try {
        const tokenToSend = csrfToken || (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '';
        if (!tokenToSend) console.warn('No CSRF token found for borrow');
        const res = await fetch(`${apiBase}/borrow`, {
          method: 'POST', credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': tokenToSend
          },
          body: JSON.stringify({ borrower_rfid: scannedRfid, item_qr: scannedQr })
        });
        if (res.status === 403) console.error('Borrow 403; csrftoken cookie=', (document.cookie.match(/csrftoken=([^;]+)/)||[])[1], 'sent header=', tokenToSend);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || 'Borrow failed');
        
        showToast(document.getElementById('borrowToast'), '‚úÖ Borrowed successfully! Redirecting...');
        
        setTimeout(() => {
          window.location.href = "{% url 'core:dashboard' %}";
        }, 1500);
      } catch (err) {
        console.error('‚ùå Borrow error:', err);
        showToast(document.getElementById('borrowToast'), '‚ùå ' + (err.message || 'Borrow failed'));
      }
    });
  }
  
  if (cancelBorrowBtn) {
    cancelBorrowBtn.addEventListener('click', () => {
      console.log('üëà Cancel Borrow clicked');
      const confirmDialog = document.getElementById('borrowConfirmDialog');
      confirmDialog.close();
      
      // Reset scanning
      scannedRfid = '';
      scannedQr = '';
      borrowerData = null;
      
      // Go back to main page
      const rfidModal = document.getElementById('rfidScanModal');
      const qrModal = document.getElementById('qrScanModal');
      if (qrModal && qrModal.open) qrModal.close();
      if (rfidModal && rfidModal.open) rfidModal.close();
      
      console.log('üîÑ Ready for new scan');
    });
  }

  // Close borrow confirmation dialog when clicking outside
  const borrowConfirmDialog = document.getElementById('borrowConfirmDialog');
  borrowConfirmDialog?.addEventListener('click', (e) => {
    if (e.target === borrowConfirmDialog) {
      borrowConfirmDialog.close();
    }
  });

  // Close RFID modal when clicking outside or pressing ESC
  const rfidScanModal = document.getElementById('rfidScanModal');
  rfidScanModal?.addEventListener('click', (e) => {
    console.log('üñ±Ô∏è Click on RFID modal backdrop detected, target:', e.target.id);
    if (e.target === rfidScanModal) {
      console.log('üì≠ Closing modal via backdrop click');
      rfidScanModal.close();
      stopBorrowRfidScan();
    }
  });

  rfidScanModal?.addEventListener('close', () => {
    console.log('üì≠ RFID modal close event fired');
    if (isBorrowScanning) {
      console.log('üõë Stopping scan on modal close');
      stopBorrowRfidScan();
    }
  });

  // Initialize button listeners
  console.log('Borrow page script loaded');
</script>
{% endblock %}
