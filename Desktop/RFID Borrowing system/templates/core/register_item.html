{% extends 'core/base.html' %}

{% block title %}Register Item - RFID Borrowing System{% endblock %}

{% block content %}
<div class="page-header">
  <h1>üì¶ Register Item</h1>
  <p>Register items before they can be borrowed. QR code will be generated automatically.</p>
</div>

<div class="content-card gradient-warm-rose">
  <form id="registerItemForm" method="post">
    {% csrf_token %}
    {% if request.user.is_staff %}
    <div id="itemFormMode" class="scan-status waiting hidden" style="margin-bottom: 16px;">Editing item</div>
    {% endif %}
    <label>Item Name
      <input id="itemName" type="text" placeholder="Enter item name" required style="padding: 12px;" />
    </label>
    
    <label>Description (Optional)
      <textarea id="itemDescription" rows="4" placeholder="Enter item description" style="padding: 12px; resize: vertical;"></textarea>
    </label>
    
    {% if request.user.is_staff %}
    <label id="itemStatusField" class="hidden">Item Status
      <select id="itemIsActive" style="padding: 12px;">
        <option value="true">Active</option>
        <option value="false">Inactive</option>
      </select>
    </label>
    {% endif %}
    
    <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">
      <button type="submit" id="itemSubmitBtn" class="btn btn-primary btn-lg" style="flex: 1;">
        <span class="btn-icon">üéØ</span>
        <span class="btn-text">Generate QR Code</span>
      </button>
      {% if request.user.is_staff %}
      <button type="button" id="cancelItemEditBtn" class="btn btn-secondary btn-lg hidden" style="flex: 1;">
        <span class="btn-icon">‚úï</span>
        <span class="btn-text">Cancel Edit</span>
      </button>
      {% endif %}
      <a href="{% url 'core:dashboard' %}" class="btn btn-outline btn-lg" style="text-decoration: none; flex: 1; display: flex; align-items: center; justify-content: center;">
        <span class="btn-icon">‚úï</span>
        <span class="btn-text">Close</span>
      </a>
    </div>
  </form>
  
  <div id="itemQrResult" class="hidden" style="margin-top: 24px; padding: 24px; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius: 16px; border: 2px solid #10b981;">
    <div class="scan-status success" style="background: transparent; border: none; padding: 0;">
      <strong style="display: block; margin-bottom: 16px; font-size: 1.3rem; color: #065f46;">‚úÖ Item Registered Successfully!</strong>
      <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px;">
        <strong style="color: #065f46;">QR Code:</strong><br>
        <span id="itemQrCode" class="mono" style="font-size: 1.2rem; color: #065f46; word-break: break-all;"></span>
      </div>
      <div id="itemQrImageContainer" style="text-align: center; margin: 16px 0; padding: 16px; background: white; border-radius: 12px;">
        <img id="itemQrImage" src="" alt="QR Code" style="max-width: 250px; border: 3px solid #10b981; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" />
      </div>
      <button type="button" id="downloadQrBtn" class="btn btn-success btn-lg" style="width: 100%;">
        <span class="btn-icon">üì•</span>
        <span class="btn-text">Download QR Code</span>
      </button>
    </div>
  </div>
  <dialog id="registerItemToast"></dialog>
</div>

{% if request.user.is_staff %}
<dialog id="deleteItemDialog">
  <form method="dialog">
    <h3>üóëÔ∏è Delete Item</h3>
    <div class="modal-message" id="deleteItemMessage">
      Are you sure you want to delete this item? This action cannot be undone.
    </div>
    <div class="modal-actions">
      <button type="button" id="confirmDeleteItemBtn" class="btn btn-danger btn-lg" style="flex:1;">
        <span class="btn-icon">üóëÔ∏è</span>
        <span class="btn-text">Delete</span>
      </button>
      <button type="button" id="cancelDeleteItemBtn" class="btn btn-secondary btn-lg" style="flex:1;">
        <span class="btn-icon">‚úï</span>
        <span class="btn-text">Cancel</span>
      </button>
    </div>
  </form>
</dialog>
{% endif %}
{% if request.user.is_staff %}
<div class="content-card" id="itemManagementCard">
  <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; margin-bottom: 16px;">
    <div>
      <h2 style="margin: 0;">Manage Items</h2>
      <p style="margin: 4px 0 0 0; color: var(--secondary-color);">Edit descriptions, toggle availability, or delete items.</p>
    </div>
    <span class="badge badge-warning">Admin tools</span>
  </div>

  <input type="search" id="itemSearchInput" placeholder="Search by name or QR code..." style="margin-bottom: 16px;" />

  <div style="overflow-x: auto;">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>QR Code</th>
          <th>Status</th>
          <th>Registered</th>
          <th style="width: 200px;">Actions</th>
        </tr>
      </thead>
      <tbody id="itemTableBody">
        <tr>
          <td colspan="5" style="text-align: center; padding: 24px;">Loading items...</td>
        </tr>
      </tbody>
    </table>
    <p id="itemEmptyState" class="hidden" style="margin-top: 12px; color: var(--secondary-color); text-align: center;">No items found.</p>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  // Note: Django template variables below - linter may show false warnings
  const apiBase = '/api';
  // eslint-disable-next-line no-undef
  const isAdmin = {{ request.user.is_staff|lower }};
  const csrfToken = document.querySelector('#registerItemForm [name=csrfmiddlewaretoken]')?.value;
  let registeredItemId = null;
  let editingItemId = null;
  let itemSearchTimeout = null;

  function showToast(dialog, message) {
    dialog.textContent = message;
    dialog.showModal();
    setTimeout(() => dialog.close(), 2200);
  }

  function clearItemForm() {
    document.getElementById('itemName').value = '';
    document.getElementById('itemDescription').value = '';
    registeredItemId = null;
    document.getElementById('itemQrResult').classList.add('hidden');
    const statusSelect = document.getElementById('itemIsActive');
    if (statusSelect) {
      statusSelect.value = 'true';
    }
    const statusField = document.getElementById('itemStatusField');
    statusField?.classList.add('hidden');
  }

  function formatDate(value) {
    if (!value) return '‚Äî';
    try {
      return new Date(value).toLocaleString();
    } catch (e) {
      return value;
    }
  }

  function escapeHtml(value) {
    const div = document.createElement('div');
    div.textContent = value ?? '';
    return div.innerHTML;
  }

  function statusBadge(isActive) {
    return isActive
      ? '<span class="badge badge-success">Active</span>'
      : '<span class="badge badge-danger">Inactive</span>';
  }

  function setItemFormMode(item) {
    if (!isAdmin) return;
    const modeBanner = document.getElementById('itemFormMode');
    const cancelBtn = document.getElementById('cancelItemEditBtn');
    const submitBtn = document.getElementById('itemSubmitBtn');
    const statusField = document.getElementById('itemStatusField');
    const statusSelect = document.getElementById('itemIsActive');

    if (item) {
      editingItemId = item.id;
      modeBanner?.classList.remove('hidden');
      if (modeBanner) {
        modeBanner.textContent = `Editing ${item.name}`;
      }
      cancelBtn?.classList.remove('hidden');
      if (submitBtn) {
        submitBtn.textContent = 'üíæ Save Changes';
      }
      document.getElementById('itemName').value = item.name || '';
      document.getElementById('itemDescription').value = item.description || '';
      statusField?.classList.remove('hidden');
      if (statusSelect) {
        statusSelect.value = item.is_active ? 'true' : 'false';
      }
      document.getElementById('itemQrResult').classList.add('hidden');
    } else {
      editingItemId = null;
      modeBanner?.classList.add('hidden');
      cancelBtn?.classList.add('hidden');
      if (submitBtn) {
        submitBtn.textContent = 'üéØ Generate QR Code';
      }
      clearItemForm();
    }
  }

  function bindItemActions(items) {
    const tbody = document.getElementById('itemTableBody');
    if (!tbody) return;
    tbody.querySelectorAll('.edit-item-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = items.find(item => item.id === Number(btn.dataset.id));
        if (target) {
          setItemFormMode(target);
        }
      });
    });
    tbody.querySelectorAll('.delete-item-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = items.find(item => item.id === Number(btn.dataset.id));
        if (!target) return;
        
        const itemName = target.name || 'Unknown';
        document.getElementById('deleteItemMessage').innerHTML = `
          <strong>Are you sure you want to delete this item?</strong><br><br>
          <div style="text-align: left; margin-top: 12px;">
            <div><strong>Name:</strong> ${escapeHtml(itemName)}</div>
            <div><strong>QR Code:</strong> <span class="mono">${escapeHtml(target.qr_code || '‚Äî')}</span></div>
            ${target.description ? `<div><strong>Description:</strong> ${escapeHtml(target.description)}</div>` : ''}
          </div>
          <div style="margin-top: 16px; padding: 12px; background: #fee2e2; border-radius: 8px; color: #991b1b; border-left: 4px solid #dc2626;">
            ‚ö†Ô∏è This action cannot be undone.
          </div>
        `;
        
        const deleteDialog = document.getElementById('deleteItemDialog');
        const confirmBtn = document.getElementById('confirmDeleteItemBtn');
        const cancelBtn = document.getElementById('cancelDeleteItemBtn');
        
        // Remove old listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        newConfirmBtn.onclick = async () => {
          deleteDialog.close();
          try {
            { const tokenToSend = csrfToken || (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || ''; if (!tokenToSend) console.warn('No CSRF token found for item delete'); const res = await fetch(`${apiBase}/items/${target.id}`, { method: 'DELETE', credentials: 'same-origin', headers: { 'X-CSRFToken': tokenToSend } }); if (res.status === 403) console.error('Delete item 403; csrftoken cookie=', (document.cookie.match(/csrftoken=([^;]+)/)||[])[1], 'sent header=', tokenToSend); if (res.status !== 204 && !res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.detail || 'Delete failed'); } }
            showToast(document.getElementById('registerItemToast'), 'üóëÔ∏è Item deleted');
            if (editingItemId === target.id) {
              setItemFormMode(null);
            }
            const query = document.getElementById('itemSearchInput')?.value.trim() || '';
            fetchItemList(query);
          } catch (err) {
            showToast(document.getElementById('registerItemToast'), `‚ùå ${err.message || 'Delete failed'}`);
          }
        };
        
        newCancelBtn.onclick = () => {
          deleteDialog.close();
        };
        
        deleteDialog.showModal();
      });
    });
    tbody.querySelectorAll('.qr-item-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.dataset.id;
        window.open(`${apiBase}/items/${targetId}/qr`, '_blank');
      });
    });
  }

  function renderItemTable(items) {
    const tbody = document.getElementById('itemTableBody');
    const emptyState = document.getElementById('itemEmptyState');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (!items.length) {
      emptyState?.classList.remove('hidden');
      return;
    }
    emptyState?.classList.add('hidden');
    items.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.name || '‚Äî'}</td>
        <td class="mono">${item.qr_code || '‚Äî'}</td>
        <td>${statusBadge(item.is_active)}</td>
        <td>${formatDate(item.created_at)}</td>
        <td>
          <div style="display:flex; gap:6px; flex-wrap: wrap;">
            <button type="button" class="action-btn action-btn--edit edit-item-btn" data-id="${item.id}" title="Edit item" aria-label="Edit item">‚úèÔ∏è</button>
            <button type="button" class="action-btn action-btn--delete delete-item-btn" data-id="${item.id}" title="Delete item" aria-label="Delete item">üóëÔ∏è</button>
            <button type="button" class="action-btn action-btn--edit qr-item-btn" data-id="${item.id}" title="Download QR" aria-label="Download QR">üìÑ</button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
    bindItemActions(items);
  }

  async function fetchItemList(query = '') {
    if (!isAdmin) return;
    const tbody = document.getElementById('itemTableBody');
    if (!tbody) return;
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 24px;">Loading items...</td></tr>';
    try {
      const res = await fetch(`${apiBase}/items${query ? `?q=${encodeURIComponent(query)}` : ''}`, { cache: 'no-store' });
      if (!res.ok) {
        throw new Error('Unable to load items');
      }
      const data = await res.json();
      renderItemTable(Array.isArray(data) ? data : []);
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 24px; color: #b91c1c;">${err.message || 'Error loading items'}</td></tr>`;
    }
  }

  if (isAdmin) {
    document.getElementById('cancelItemEditBtn')?.addEventListener('click', () => setItemFormMode(null));
    const searchInput = document.getElementById('itemSearchInput');
    if (searchInput) {
      searchInput.addEventListener('input', (event) => {
        const query = event.target.value.trim();
        clearTimeout(itemSearchTimeout);
        itemSearchTimeout = setTimeout(() => {
          fetchItemList(query);
        }, 300);
      });
    }
    fetchItemList();
  }

  document.getElementById('registerItemForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const toast = document.getElementById('registerItemToast');
    const name = document.getElementById('itemName').value.trim();
    const description = document.getElementById('itemDescription').value.trim();
    const statusSelect = document.getElementById('itemIsActive');
    const isActiveValue = statusSelect ? statusSelect.value === 'true' : true;

    if (editingItemId) {
      try {
        { const tokenToSend = csrfToken || (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || ''; if (!tokenToSend) console.warn('No CSRF token found for item update'); const res = await fetch(`${apiBase}/items/${editingItemId}`, { method: 'PATCH', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': tokenToSend }, body: JSON.stringify({ name, description, is_active: isActiveValue }) }); if (res.status === 403) console.error('Update item 403; csrftoken cookie=', (document.cookie.match(/csrftoken=([^;]+)/)||[])[1], 'sent header=', tokenToSend); const data = await res.json().catch(() => ({})); if (!res.ok) throw new Error(data.detail || 'Update failed'); }
        showToast(toast, 'üíæ Item updated');
        setItemFormMode(null);
        const query = document.getElementById('itemSearchInput')?.value.trim() || '';
        fetchItemList(query);
      } catch (err) {
        showToast(toast, '‚ùå ' + (err.message || 'Update failed'));
      }
      return;
    }
    
    try {
      const tokenToSend = csrfToken || (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '';
      if (!tokenToSend) console.warn('No CSRF token found for item registration');
      const res = await fetch(`${apiBase}/register-item`, {
        method: 'POST', credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': tokenToSend
        },
        body: JSON.stringify({
          name: name,
          description: description
        })
      });
      if (res.status === 403) console.error('Register item 403; csrftoken cookie=', (document.cookie.match(/csrftoken=([^;]+)/)||[])[1], 'sent header=', tokenToSend);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || 'Registration failed');
      
      registeredItemId = data.id;
      document.getElementById('itemQrCode').textContent = data.qr_code;
      document.getElementById('itemQrImage').src = `${apiBase}/items/${data.id}/qr`;
      document.getElementById('itemQrResult').classList.remove('hidden');
      showToast(toast, '‚úÖ Item registered successfully!');
      if (isAdmin) {
        const query = document.getElementById('itemSearchInput')?.value.trim() || '';
        fetchItemList(query);
      }
    } catch (e) {
      showToast(toast, '‚ùå ' + (e.message || 'Error'));
    }
  });
  
  document.getElementById('downloadQrBtn').addEventListener('click', () => {
    if (registeredItemId) {
      window.open(`${apiBase}/items/${registeredItemId}/qr`, '_blank');
    }
  });

  // Close delete dialog when clicking outside
  if (isAdmin) {
    const deleteDialog = document.getElementById('deleteItemDialog');
    deleteDialog?.addEventListener('click', (e) => {
      if (e.target === deleteDialog) {
        deleteDialog.close();
      }
    });
  }
</script>
{% endblock %}
