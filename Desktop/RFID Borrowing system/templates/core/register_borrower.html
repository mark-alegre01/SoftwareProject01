{% extends 'core/base.html' %}

{% block title %}Register Borrower - RFID Borrowing System{% endblock %}

{% block content %}
<div class="page-header">
  <h1>ğŸ‘¤ Register Borrower</h1>
  <p>First-time borrowers must register before borrowing items</p>
</div>

<div class="content-card gradient-warm-amber">
  <form id="registerBorrowerForm" method="post">
    {% csrf_token %}
    <input type="hidden" id="borrowerQrData" name="borrower_qr_data" />

    {% if request.user.is_staff %}
    <div id="borrowerFormMode" class="scan-status waiting hidden" style="margin-bottom: 16px;">Editing borrower</div>
    {% endif %}
    <label>Scan User QR Code (Optional)
      <div style="background: #e0f2fe; padding: 12px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #0284c7;">
        <strong style="display: block; margin-bottom: 8px; color: #0c4a6e;">ğŸ“± Use Phone Camera:</strong>
        <p style="margin: 0; font-size: 0.9rem; color: #0c4a6e;">
          <strong>Easiest:</strong> Open <code style="background: white; padding: 2px 6px; border-radius: 4px;">http://192.168.1.38:8000{% url 'core:register-borrower' %}</code> on your phone browser (same WiFi network)
        </p>
      </div>
      <button type="button" id="scanBorrowerQrBtn" class="btn btn-primary btn-lg" style="width: 100%; margin-bottom: 12px;">
        <span class="btn-icon">ğŸ“·</span>
        <span class="btn-text">Scan QR Code</span>
      </button>
      <div id="borrowerQrReader" style="display: none;"></div>
      <div id="cameraPermissionHelp" class="hidden" style="background: #fef3c7; padding: 16px; border-radius: 10px; margin: 12px 0; border-left: 4px solid #f59e0b;">
        <strong style="display: block; margin-bottom: 8px; color: #92400e;">ğŸ“· How to Enable Camera Access:</strong>
        <ul style="margin: 8px 0; padding-left: 20px; color: #92400e; font-size: 0.9rem;">
          <li><strong>Chrome/Edge:</strong> Click the camera icon (ğŸ“·) in the address bar â†’ Allow</li>
          <li><strong>Firefox:</strong> Click the padlock icon â†’ Permissions â†’ Camera â†’ Allow</li>
          <li><strong>Safari:</strong> Safari â†’ Settings â†’ Websites â†’ Camera â†’ Allow</li>
          <li><strong>Mobile:</strong> Go to browser settings â†’ Site permissions â†’ Camera â†’ Allow</li>
        </ul>
        <p style="margin: 8px 0 0 0; color: #92400e; font-size: 0.85rem;"><strong>Note:</strong> If using localhost (127.0.0.1), camera access works automatically. For network access, HTTPS may be required.</p>
        <button type="button" id="retryBorrowerCamera" class="btn btn-primary btn-lg">
          <span class="btn-icon">ğŸ”„</span>
          <span class="btn-text">Retry Camera</span>
        </button>
      </div>
    </label>
    
    <label>Name
      <input id="borrowerName" type="text" placeholder="Enter borrower name" required style="padding: 12px;" />
    </label>
    
    <label>Email (Optional)
      <input id="borrowerEmail" type="email" placeholder="Enter email address" style="padding: 12px;" />
    </label>
    
    <label>Tap School ID Card (RFID)
      <input id="borrowerRfidInput" class="mono" type="text" placeholder="Tap RFID card to get UID" required style="padding: 12px; font-size: 1.1rem;" readonly />
    </label>
    <button type="button" id="startRfidScanBtn" class="btn btn-primary btn-lg" style="width: 100%; margin-top: 8px;">
      <span class="btn-icon">ğŸ“±</span>
      <span class="btn-text">Start RFID Scan</span>
    </button>
    <div class="scan-status waiting" id="borrowerRfidStatus">Click "Start RFID Scan" button, then tap the card...</div>
    
    <div style="display: flex; gap: 12px; margin-top: 20px;">
      <button type="submit" id="borrowerSubmitBtn" class="btn btn-primary btn-lg" style="flex: 1;">
        <span class="btn-icon">âœ“</span>
        <span class="btn-text">Register Borrower</span>
      </button>
      {% if request.user.is_staff %}
      <button type="button" id="cancelBorrowerEditBtn" class="btn btn-secondary btn-lg hidden" style="flex: 1;">
        <span class="btn-icon">âœ•</span>
        <span class="btn-text">Cancel Edit</span>
      </button>
      {% endif %}
      <a href="{% url 'core:dashboard' %}" class="btn btn-outline btn-lg" style="text-decoration: none; flex: 1;">
        <span class="btn-icon">âœ•</span>
        <span class="btn-text">Close</span>
      </a>
    </div>
  </form>
  <dialog id="registerBorrowerToast"></dialog>
</div>

{% if request.user.is_staff %}
<dialog id="editBorrowerDialog">
  <form id="editBorrowerForm" method="dialog">
    <h3>Edit Borrower</h3>
    <label>Name
      <input type="text" id="editBorrowerName" required />
    </label>
    <label>Email (Optional)
      <input type="email" id="editBorrowerEmail" />
    </label>
    <label>RFID UID
      <input type="text" id="editBorrowerRfid" class="mono" required />
    </label>
    <div class="modal-actions">
      <button type="submit" class="btn btn-success btn-lg" style="flex:1;">
        <span class="btn-icon">ğŸ’¾</span>
        <span class="btn-text">Save Changes</span>
      </button>
      <button type="button" id="cancelEditBorrowerBtn" class="btn btn-secondary btn-lg" style="flex:1;">
        <span class="btn-icon">âœ•</span>
        <span class="btn-text">Cancel</span>
      </button>
    </div>
  </form>
</dialog>

<dialog id="deleteBorrowerDialog">
  <form method="dialog">
    <h3>ğŸ—‘ï¸ Delete Borrower</h3>
    <div class="modal-message" id="deleteBorrowerMessage">
      Are you sure you want to delete this borrower? This action cannot be undone.
    </div>
    <div class="modal-actions">
      <button type="button" id="confirmDeleteBorrowerBtn" class="btn btn-danger btn-lg" style="flex:1;">
        <span class="btn-icon">ğŸ—‘ï¸</span>
        <span class="btn-text">Delete</span>
      </button>
      <button type="button" id="cancelDeleteBorrowerBtn" class="btn btn-secondary btn-lg" style="flex:1;">
        <span class="btn-icon">âœ•</span>
        <span class="btn-text">Cancel</span>
      </button>
    </div>
  </form>
</dialog>
{% endif %}

{% if request.user.is_staff %}
<div class="content-card" id="borrowerManagementCard">
  <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; margin-bottom: 16px;">
    <div>
      <h2 style="margin: 0;">Manage Borrowers</h2>
    </div>
    <span class="badge badge-warning">Admin tools</span>
  </div>

  <input type="search" id="borrowerSearchInput" placeholder="Search by name or RFID..." style="margin-bottom: 16px;" />

  <div style="overflow-x: auto;">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>RFID UID</th>
          <th>Email</th>
          <th>Registered</th>
          <th style="width: 160px;">Actions</th>
        </tr>
      </thead>
      <tbody id="borrowerTableBody">
        <tr>
          <td colspan="5" style="text-align: center; padding: 24px;">Loading borrowers...</td>
        </tr>
      </tbody>
    </table>
    <p id="borrowerEmptyState" class="hidden" style="margin-top: 12px; color: var(--secondary-color); text-align: center;">No borrowers found.</p>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  // Note: Django template variables below - linter may show false warnings
  const apiBase = '/api';
  // eslint-disable-next-line no-undef
  const isAdmin = {{ request.user.is_staff|lower }};
  let borrowerQrScanner = null;
  const csrfToken = document.querySelector('#registerBorrowerForm [name=csrfmiddlewaretoken]')?.value;
  const borrowerQrDataInput = document.getElementById('borrowerQrData');
  let editingBorrowerId = null;
  let borrowerSearchTimeout = null;

  function showToast(dialog, message) {
    dialog.textContent = message;
    dialog.showModal();
    setTimeout(() => dialog.close(), 2200);
  }

  function clearBorrowerForm() {
    document.getElementById('borrowerName').value = '';
    document.getElementById('borrowerEmail').value = '';
    const rfidInput = document.getElementById('borrowerRfidInput');
    rfidInput.value = '';
    rfidInput.readOnly = true;
    const statusEl = document.getElementById('borrowerRfidStatus');
    statusEl.textContent = 'Click "Start RFID Scan" button, then tap the card...';
    statusEl.className = 'scan-status waiting';
    lastScanId = null;
    stopRfidScan();
    if (borrowerQrDataInput) {
      borrowerQrDataInput.value = '';
    }
  }

  function setBorrowerFormMode(borrower) {
    if (!isAdmin) {
      return;
    }
    const modeBanner = document.getElementById('borrowerFormMode');
    const cancelBtn = document.getElementById('cancelBorrowerEditBtn');
    const submitBtn = document.getElementById('borrowerSubmitBtn');
    const rfidInput = document.getElementById('borrowerRfidInput');
    const statusEl = document.getElementById('borrowerRfidStatus');

    if (borrower) {
      editingBorrowerId = borrower.id;
      modeBanner?.classList.remove('hidden');
      if (modeBanner) {
        modeBanner.textContent = `Editing ${borrower.name || borrower.rfid_uid}`;
      }
      cancelBtn?.classList.remove('hidden');
      if (submitBtn) {
        submitBtn.textContent = 'ğŸ’¾ Save Changes';
      }
      document.getElementById('borrowerName').value = borrower.name || '';
      document.getElementById('borrowerEmail').value = borrower.email || '';
      rfidInput.value = borrower.rfid_uid || '';
      rfidInput.readOnly = false;
      statusEl.textContent = borrower.rfid_uid ? `âœï¸ Editing RFID: ${borrower.rfid_uid}` : 'Update RFID UID';
      statusEl.className = 'scan-status waiting';
      stopRfidScan();
    } else {
      editingBorrowerId = null;
      modeBanner?.classList.add('hidden');
      cancelBtn?.classList.add('hidden');
      if (submitBtn) {
        submitBtn.textContent = 'âœ“ Register Borrower';
      }
      clearBorrowerForm();
    }
  }

  function escapeHtml(value) {
    const div = document.createElement('div');
    div.textContent = value ?? '';
    return div.innerHTML;
  }

  function formatDate(value) {
    if (!value) return 'â€”';
    try {
      return new Date(value).toLocaleString();
    } catch (err) {
      return value;
    }
  }

  function bindBorrowerActions(borrowers) {
    const tbody = document.getElementById('borrowerTableBody');
    if (!tbody) return;
    tbody.querySelectorAll('.edit-borrower-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = borrowers.find(b => b.id === Number(btn.dataset.id));
        if (!target) return;
        
        // Populate edit modal
        document.getElementById('editBorrowerName').value = target.name || '';
        document.getElementById('editBorrowerEmail').value = target.email || '';
        document.getElementById('editBorrowerRfid').value = target.rfid_uid || '';
        
        const editDialog = document.getElementById('editBorrowerDialog');
        const editForm = document.getElementById('editBorrowerForm');
        const cancelBtn = document.getElementById('cancelEditBorrowerBtn');
        
        // Remove old listeners
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        newCancelBtn.onclick = () => {
          editDialog.close();
        };
        
        // Handle form submission
        const handleSubmit = async (e) => {
          e.preventDefault();
          const name = document.getElementById('editBorrowerName').value.trim();
          const email = document.getElementById('editBorrowerEmail').value.trim();
          const rfid = document.getElementById('editBorrowerRfid').value.trim();
          
          if (!name || !rfid) {
            showToast(document.getElementById('registerBorrowerToast'), 'Please fill in all required fields');
            return;
          }
          
          try {
            const res = await fetch(`${apiBase}/borrowers/${target.id}`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || ''
              },
              body: JSON.stringify({ name, email, rfid_uid: rfid })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.detail || 'Update failed');
            
            showToast(document.getElementById('registerBorrowerToast'), 'ğŸ’¾ Borrower updated');
            editDialog.close();
            editForm.removeEventListener('submit', handleSubmit);
            const query = document.getElementById('borrowerSearchInput')?.value.trim() || '';
            fetchBorrowerList(query);
          } catch (err) {
            showToast(document.getElementById('registerBorrowerToast'), `âŒ ${err.message || 'Update failed'}`);
          }
        };
        
        editForm.addEventListener('submit', handleSubmit);
        editDialog.showModal();
      });
    });
    tbody.querySelectorAll('.delete-borrower-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = borrowers.find(b => b.id === Number(btn.dataset.id));
        if (!target) {
          return;
        }
        
        const borrowerName = target.name || target.rfid_uid || 'Unknown';
        const openCount = target.open_transactions_count || 0;
        
        let messageHtml = `
          <strong>${openCount > 0 ? 'Cannot Delete Borrower' : 'Are you sure you want to delete this borrower?'}</strong><br><br>
          <div style="text-align: left; margin-top: 12px;">
            <div><strong>Name:</strong> ${escapeHtml(borrowerName)}</div>
            <div><strong>RFID UID:</strong> <span class="mono">${escapeHtml(target.rfid_uid || 'â€”')}</span></div>
            ${target.email ? `<div><strong>Email:</strong> ${escapeHtml(target.email)}</div>` : ''}
          </div>
        `;
        
        if (openCount > 0) {
          messageHtml += `
            <div style="margin-top: 16px; padding: 12px; background: #fee2e2; border-radius: 8px; color: #991b1b; border-left: 4px solid #dc2626;">
              <strong>âš ï¸ Cannot Delete:</strong> This borrower currently has <strong>${openCount}</strong> borrowed item(s).<br>
              Please return all items before deleting this borrower.
            </div>
          `;
        } else {
          messageHtml += `
            <div style="margin-top: 16px; padding: 12px; background: #fee2e2; border-radius: 8px; color: #991b1b; border-left: 4px solid #dc2626;">
              âš ï¸ This action cannot be undone.
            </div>
          `;
        }
        
        document.getElementById('deleteBorrowerMessage').innerHTML = messageHtml;
        
        const deleteDialog = document.getElementById('deleteBorrowerDialog');
        const confirmBtn = document.getElementById('confirmDeleteBorrowerBtn');
        const cancelBtn = document.getElementById('cancelDeleteBorrowerBtn');
        
        // Disable delete button if borrower has open transactions
        if (openCount > 0) {
          confirmBtn.disabled = true;
          confirmBtn.style.opacity = '0.5';
          confirmBtn.style.cursor = 'not-allowed';
        } else {
          confirmBtn.disabled = false;
          confirmBtn.style.opacity = '1';
          confirmBtn.style.cursor = 'pointer';
        }
        
        // Remove old listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        if (openCount === 0) {
          newConfirmBtn.onclick = async () => {
            deleteDialog.close();
            try {
              console.log('ğŸ—‘ï¸ Deleting borrower:', {
                id: target.id,
                name: target.name,
                rfid: target.rfid_uid?.substring(0, 10) + '...'
              });
              
              const res = await fetch(`${apiBase}/borrowers/${target.id}`, {
                method: 'DELETE',
                headers: {
                  'X-CSRFToken': csrfToken || ''
                }
              });
              
              console.log('Delete response:', {
                status: res.status,
                statusText: res.statusText
              });
              
              if (res.status !== 204 && !res.ok) {
                const data = await res.json().catch(() => ({}));
                throw new Error(data.detail || 'Delete failed');
              }
              
              console.log('âœ… Borrower deleted successfully');
              const toast = document.getElementById('registerBorrowerToast');
              showToast(toast, 'ğŸ—‘ï¸ Borrower deleted');
              if (editingBorrowerId === target.id) {
                setBorrowerFormMode(null);
              }
              const query = document.getElementById('borrowerSearchInput')?.value.trim() || '';
              fetchBorrowerList(query);
            } catch (err) {
              console.error('âŒ Delete error:', err);
              const toast = document.getElementById('registerBorrowerToast');
              showToast(toast, `âŒ ${err.message || 'Delete failed'}`);
            }
          };
        } else {
          newConfirmBtn.onclick = () => {
            // Do nothing if disabled
          };
        }
        
        newCancelBtn.onclick = () => {
          deleteDialog.close();
        };
        
        deleteDialog.showModal();
      });
    });
  }

  function renderBorrowerTable(borrowers) {
    const tbody = document.getElementById('borrowerTableBody');
    const emptyState = document.getElementById('borrowerEmptyState');
    if (!tbody) return;

    tbody.innerHTML = '';
    if (!borrowers.length) {
      emptyState?.classList.remove('hidden');
      return;
    }

    emptyState?.classList.add('hidden');
    borrowers.forEach(borrower => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${escapeHtml(borrower.name || 'â€”')}</td>
        <td class="mono">${escapeHtml(borrower.rfid_uid || 'â€”')}</td>
        <td>${escapeHtml(borrower.email || 'â€”')}</td>
        <td>${formatDate(borrower.created_at)}</td>
        <td>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <button type="button" class="action-btn action-btn--edit edit-borrower-btn" data-id="${borrower.id}" title="Edit borrower" aria-label="Edit borrower">âœï¸</button>
            <button type="button" class="action-btn action-btn--delete delete-borrower-btn" data-id="${borrower.id}" 
              title="${(borrower.open_transactions_count || 0) > 0 ? 'Cannot delete: Borrower has borrowed items' : 'Delete borrower'}" 
              aria-label="Delete borrower"
              ${(borrower.open_transactions_count || 0) > 0 ? 'style="opacity: 0.5; cursor: not-allowed;"' : ''}>ğŸ—‘ï¸</button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });

    bindBorrowerActions(borrowers);
  }

  async function fetchBorrowerList(query = '') {
    if (!isAdmin) return;
    const tbody = document.getElementById('borrowerTableBody');
    if (!tbody) return;
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 24px;">Loading borrowers...</td></tr>';

    try {
      const res = await fetch(`${apiBase}/borrowers${query ? `?q=${encodeURIComponent(query)}` : ''}`, { cache: 'no-store' });
      if (!res.ok) {
        throw new Error('Unable to load borrowers');
      }
      const data = await res.json();
      renderBorrowerTable(Array.isArray(data) ? data : []);
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 24px; color: #b91c1c;">${err.message || 'Error loading borrowers'}</td></tr>`;
    }
  }

  if (isAdmin) {
    document.getElementById('cancelBorrowerEditBtn')?.addEventListener('click', () => setBorrowerFormMode(null));
    const searchInput = document.getElementById('borrowerSearchInput');
    if (searchInput) {
      searchInput.addEventListener('input', (event) => {
        const query = event.target.value.trim();
        clearTimeout(borrowerSearchTimeout);
        borrowerSearchTimeout = setTimeout(() => {
          fetchBorrowerList(query);
        }, 300);
      });
    }
    fetchBorrowerList();
  }

  document.getElementById('scanBorrowerQrBtn').addEventListener('click', async () => {
    const qrReader = document.getElementById('borrowerQrReader');
    qrReader.style.display = 'block';
    qrReader.innerHTML = '';
    
    try {
      // Check camera permissions
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop());
        document.getElementById('cameraPermissionHelp').classList.add('hidden');
      } catch (permErr) {
        document.getElementById('cameraPermissionHelp').classList.remove('hidden');
        qrReader.style.display = 'none';
        return;
      }
      
      borrowerQrScanner = new Html5Qrcode('borrowerQrReader');
      
      // Try back camera first, fallback to any camera
      let cameraId = null;
      try {
        const devices = await Html5Qrcode.getCameras();
        if (devices && devices.length > 0) {
          const backCamera = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('rear'));
          cameraId = backCamera ? backCamera.id : devices[0].id;
        }
      } catch (e) {
        console.log('Could not enumerate cameras, using default');
      }
      
      const config = cameraId 
        ? { deviceId: { exact: cameraId } }
        : { facingMode: 'environment' };
      
      await borrowerQrScanner.start(
        config,
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          const text = decodedText.trim();
          document.getElementById('borrowerQrData').value = text;
          // Attempt to parse name/email from pipe-delimited format
          try {
            if (text.includes('|')) {
              const parts = text.split('|').map(p => p.trim());
              if (parts[0]) {
                const raw = parts[0];
                if (raw.includes(',')) {
                  const [last, first] = raw.split(',', 2).map(s => s.trim());
                  const pretty = `${first} ${last}`.replace(/\s+/g, ' ').trim();
                  document.getElementById('borrowerName').value = pretty;
                } else {
                  document.getElementById('borrowerName').value = raw;
                }
              }
              if (parts[2] && parts[2].includes('@')) {
                document.getElementById('borrowerEmail').value = parts[2];
              }
            }
          } catch (e) {
            // ignore parse errors
          }
          borrowerQrScanner.stop().then(() => {
            borrowerQrScanner.clear();
            borrowerQrScanner = null;
            qrReader.style.display = 'none';
          }).catch(() => {});
        },
        (errorMessage) => {
          // Ignore scanning errors
        }
      );
    } catch (err) {
      let errorMsg = 'Camera error: ';
      if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
        errorMsg = 'âŒ Camera permission denied. Please allow camera access and try again.';
      } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
        errorMsg = 'âŒ No camera found. Please connect a camera device.';
      } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
        errorMsg = 'âŒ Camera is already in use by another application.';
      } else if (err.message) {
        errorMsg = 'âŒ Camera error: ' + err.message;
      } else if (err.toString) {
        errorMsg = 'âŒ Camera error: ' + err.toString();
      } else {
        errorMsg = 'âŒ Unable to access camera. Please check your browser settings and try again.';
      }
      if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
        document.getElementById('cameraPermissionHelp').classList.remove('hidden');
      } else {
        alert(errorMsg);
      }
      qrReader.style.display = 'none';
    }
  });
  
  document.getElementById('retryBorrowerCamera').addEventListener('click', () => {
    document.getElementById('scanBorrowerQrBtn').click();
  });
  
  document.getElementById('registerBorrowerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const toast = document.getElementById('registerBorrowerToast');
    const name = document.getElementById('borrowerName').value.trim();
    const email = document.getElementById('borrowerEmail').value.trim();
    const rfid = document.getElementById('borrowerRfidInput').value.trim();
    const qrPayload = borrowerQrDataInput?.value?.trim();
    
    if (!rfid) {
      showToast(toast, 'Please tap the school ID card to get RFID UID');
      return;
    }

    if (editingBorrowerId) {
      try {
        const res = await fetch(`${apiBase}/borrowers/${editingBorrowerId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken || ''
          },
          body: JSON.stringify({
            name,
            email,
            rfid_uid: rfid
          })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || 'Update failed');
        showToast(toast, 'ğŸ’¾ Borrower updated');
        setBorrowerFormMode(null);
        const query = document.getElementById('borrowerSearchInput')?.value.trim() || '';
        fetchBorrowerList(query);
      } catch (err) {
        showToast(toast, 'âŒ ' + (err.message || 'Update failed'));
      }
      return;
    }
    
    try {
      console.log('ğŸ“¤ Submitting borrower registration:', {
        name,
        email,
        rfid: rfid.substring(0, 10) + '...' // Log first 10 chars of RFID
      });
      
      const res = await fetch(`${apiBase}/register-borrower`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken || ''
        },
        body: JSON.stringify({
          name: name,
          email: email,
          rfid_uid: rfid,
          qr_data: qrPayload || ''
        })
      });
      
      const data = await res.json().catch(() => ({}));
      console.log('ğŸ“¥ Registration response:', {
        status: res.status,
        statusText: res.statusText,
        data: data
      });
      
      if (!res.ok) {
        const errorMsg = data.detail || data.message || 'Registration failed';
        console.error('âŒ Registration failed:', {
          status: res.status,
          error: errorMsg,
          fullResponse: data
        });
        throw new Error(errorMsg);
      }
      
      console.log('âœ… Registration successful, borrower ID:', data.id);
      
      // Clear all input fields after successful submission
      clearBorrowerForm();
      
      showToast(toast, 'âœ… Borrower registered successfully! Redirecting...');
      if (isAdmin) {
        const query = document.getElementById('borrowerSearchInput')?.value.trim() || '';
        fetchBorrowerList(query);
      }
      setTimeout(() => {
        window.location.href = "{% url 'core:dashboard' %}";
      }, 1500);
    } catch (e) {
      console.error('âŒ Registration error:', e);
      showToast(toast, 'âŒ ' + (e.message || 'Error'));
    }
  });
  
  document.getElementById('borrowerRfidInput').addEventListener('input', (e) => {
    const rfid = e.target.value.trim();
    if (rfid && rfid.length >= 4) {
      document.getElementById('borrowerRfidStatus').textContent = `âœ… RFID scanned: ${rfid}`;
      document.getElementById('borrowerRfidStatus').className = 'scan-status success';
    }
  });

  let pollInterval = null;
  let isScanning = false;
  let lastScanId = null;
  
  async function pollLatestScan() {
    if (!isScanning) {
      return;
    }
    
    const rfidInput = document.getElementById('borrowerRfidInput');
    if (!rfidInput || !rfidInput.offsetParent) {
      return;
    }
    
    try {
      const res = await fetch(`${apiBase}/rfid-scans`, { cache: 'no-store' });
      if (res.status === 204) {
        return;
      }
      if (!res.ok) {
        console.warn('RFID scan API returned error:', res.status);
        return;
      }
      const data = await res.json();
      if (!data || !data.id) {
        return;
      }
      
      // Only process if it's a NEW scan (different ID)
      if (data.id === lastScanId) {
        return;
      }
      
      console.log('New RFID scan detected:', data.uid, 'ID:', data.id);
      lastScanId = data.id;
      
      if (data.uid && data.uid.trim().length >= 4) {
        rfidInput.value = data.uid;
        rfidInput.readOnly = false; // Allow editing after scan
        const statusEl = document.getElementById('borrowerRfidStatus');
        statusEl.textContent = `âœ… RFID scanned: ${data.uid}`;
        statusEl.className = 'scan-status success';
        
        // Auto-fill name and email if available
        const nameInput = document.getElementById('borrowerName');
        if (data.name && !nameInput.value) {
          nameInput.value = data.name;
        }
        const emailInput = document.getElementById('borrowerEmail');
        if (data.email && !emailInput.value) {
          emailInput.value = data.email;
        }
        
        // Stop scanning after successful scan
        stopRfidScan();
      }
    } catch (err) {
      console.error('Error polling RFID scans:', err);
    }
  }

  // Start RFID scanning
  function startRfidScan() {
    if (isScanning) {
      console.log('Already scanning, ignoring...');
      return;
    }
    
    console.log('Starting RFID scan...');
    isScanning = true;
    const rfidInput = document.getElementById('borrowerRfidInput');
    const statusEl = document.getElementById('borrowerRfidStatus');
    const scanBtn = document.getElementById('startRfidScanBtn');
    
    if (!rfidInput || !statusEl || !scanBtn) {
      console.error('Required elements not found!', { rfidInput, statusEl, scanBtn });
      isScanning = false;
      return;
    }
    
    // Clear previous values
    rfidInput.value = '';
    rfidInput.readOnly = true;
    lastScanId = null;
    
    // Update UI
    statusEl.textContent = 'ğŸ“± Scanning... Tap the RFID card now...';
    statusEl.className = 'scan-status waiting';
    scanBtn.textContent = 'â¹ï¸ Stop Scanning';
    scanBtn.style.background = '#ef4444';
    scanBtn.style.color = 'white';
    
    console.log('UI updated, starting polling...');
    
    // Initialize by getting current last scan ID
    fetch(`${apiBase}/rfid-scans`, { cache: 'no-store' })
      .then(res => {
        if (res.ok && res.status !== 204) {
          return res.json();
        }
        return null;
      })
      .then(data => {
        if (data && data.id) {
          lastScanId = data.id;
          console.log('Initial scan ID set:', lastScanId);
        }
        // Start polling
        console.log('Starting polling interval...');
        pollLatestScan();
        if (pollInterval) {
          clearInterval(pollInterval);
        }
        pollInterval = setInterval(pollLatestScan, 2000);
      })
      .catch((err) => {
        console.error('Error initializing scan:', err);
        // Start polling anyway
        pollLatestScan();
        if (pollInterval) {
          clearInterval(pollInterval);
        }
        pollInterval = setInterval(pollLatestScan, 2000);
      });
  }
  
  // Stop RFID scanning
  function stopRfidScan() {
    isScanning = false;
    if (pollInterval) {
      clearInterval(pollInterval);
      pollInterval = null;
    }
    
    const scanBtn = document.getElementById('startRfidScanBtn');
    const statusEl = document.getElementById('borrowerRfidStatus');
    
    scanBtn.textContent = 'ğŸ“± Start RFID Scan';
    scanBtn.style.background = '';
    
    if (!document.getElementById('borrowerRfidInput').value) {
      statusEl.textContent = 'Click "Start RFID Scan" button, then tap the card...';
      statusEl.className = 'scan-status waiting';
    }
  }
  
  // Button click handler - wait for DOM to be ready
  function initRfidScanButton() {
    const scanBtn = document.getElementById('startRfidScanBtn');
    if (!scanBtn) {
      console.error('Start RFID Scan button not found!');
      return;
    }
    
    scanBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (isScanning) {
        stopRfidScan();
      } else {
        startRfidScan();
      }
    });
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRfidScanButton);
  } else {
    initRfidScanButton();
  }

  // Close dialogs when clicking outside
  if (isAdmin) {
    const deleteDialog = document.getElementById('deleteBorrowerDialog');
    deleteDialog?.addEventListener('click', (e) => {
      if (e.target === deleteDialog) {
        deleteDialog.close();
      }
    });
    
    const editDialog = document.getElementById('editBorrowerDialog');
    editDialog?.addEventListener('click', (e) => {
      if (e.target === editDialog) {
        editDialog.close();
      }
    });
  }
  
  // Clear fields after successful submission
  document.getElementById('registerBorrowerForm').addEventListener('submit', async (e) => {
    // Let the form submit normally, but we'll clear after success
    const originalSubmit = e.target.onsubmit;
    e.target.onsubmit = null;
  });
</script>
{% endblock %}
